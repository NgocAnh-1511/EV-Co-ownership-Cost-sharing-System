<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n L√Ω H·ª£p ƒê·ªìng Ph√°p L√Ω ƒêi·ªán T·ª≠ - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/css/admin-layout.css" rel="stylesheet">
    <th:block th:replace="fragments/admin-guard :: scripts"></th:block>
    <style>
        body {
            background: #F9FAFB;
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
        }

        .main-content {
            flex: 1;
            margin-left: 300px;
            padding: 0;
        }

        .content-wrapper {
            padding: 24px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }

        .search-filter-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
            position: relative;
        }

        .search-input i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .search-input input {
            width: 100%;
            padding: 10px 12px 10px 40px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .filter-select {
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            min-width: 180px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stat-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .stat-icon.blue { background: #667eea; }
        .stat-icon.green { background: #10b981; }
        .stat-icon.orange { background: #f59e0b; }
        .stat-icon.gray { background: #6b7280; }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1a202c;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead th {
            background: #f8fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #64748b;
            border-bottom: 2px solid #e2e8f0;
        }

        tbody td {
            padding: 16px 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        tbody tr:hover {
            background: #f8fafc;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            display: inline-block;
        }

        .status-badge.status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.status-signed {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.status-archived {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-action {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 0 4px;
            font-size: 14px;
        }

        .btn-action.btn-edit {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-action.btn-edit:hover {
            background: #bfdbfe;
        }

        .btn-action.btn-sign {
            background: #d1fae5;
            color: #065f46;
        }

        .btn-action.btn-sign:hover {
            background: #a7f3d0;
        }

        .btn-action.btn-archive {
            background: #e5e7eb;
            color: #374151;
        }

        .btn-action.btn-archive:hover {
            background: #d1d5db;
        }

        .btn-action.btn-delete {
            background: #fee2e2;
            color: #991b1b;
        }

        .btn-action.btn-delete:hover {
            background: #fecaca;
        }

        .btn-action.btn-view {
            background: #e0e7ff;
            color: #3730a3;
        }

        .btn-action.btn-view:hover {
            background: #c7d2fe;
        }

        .pagination {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .pagination-info {
            color: #64748b;
            font-size: 14px;
        }

        .pagination-controls {
            display: flex;
            gap: 8px;
        }

        .pagination-controls a {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            text-decoration: none;
            color: #64748b;
            background: white;
        }

        .pagination-controls a.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination-controls a:hover:not(.disabled) {
            background: #f8fafc;
        }

        .pagination-controls a.disabled {
            color: #94a3b8;
            background: #f8fafc;
            cursor: not-allowed;
            pointer-events: none;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .close {
            font-size: 28px;
            font-weight: bold;
            color: #94a3b8;
            cursor: pointer;
        }

        .close:hover {
            color: #1a202c;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #1a202c;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .required {
            color: #ef4444;
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .btn-cancel {
            padding: 10px 20px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            color: #64748b;
        }

        .btn-save {
            padding: 10px 20px;
            border: none;
            background: #667eea;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .btn-delete-confirm {
            padding: 10px 20px;
            border: none;
            background: #ef4444;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #9CA3AF;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            display: block;
            opacity: 0.3;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .history-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-action {
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 4px;
        }

        .history-date {
            font-size: 12px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <!-- Sidebar t·ª´ admin-sidebar.html -->
    <div th:replace="fragments/admin-sidebar :: sidebar"></div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Header Fragment -->
        <div th:replace="fragments/admin-header :: header"></div>

        <!-- Content Wrapper -->
        <div class="content-wrapper">
        <!-- Search and Filter -->
        <div class="card">
            <form id="searchFilterForm" method="get" th:action="@{/admin/legal-contracts}" class="search-filter-bar">
                <div class="search-input">
                    <i class="fas fa-search"></i>
                    <input type="text" 
                           id="searchInput" 
                           name="searchQuery" 
                           th:value="${searchQuery}" 
                           placeholder="T√¨m ki·∫øm theo m√£ h·ª£p ƒë·ªìng, ID...">
                </div>
                <select name="statusFilter" th:value="${statusFilter}" onchange="this.form.submit()" class="filter-select">
                    <option value="all" th:selected="${statusFilter == 'all'}">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                    <option value="pending" th:selected="${statusFilter == 'pending'}">Ch·ªù k√Ω</option>
                    <option value="signed" th:selected="${statusFilter == 'signed'}">ƒê√£ k√Ω</option>
                    <option value="archived" th:selected="${statusFilter == 'archived'}">ƒê√£ l∆∞u tr·ªØ</option>
                </select>
                <button type="button" class="btn-primary" onclick="openAddContractModal()">
                    <i class="fas fa-plus"></i> T·∫°o H·ª£p ƒê·ªìng M·ªõi
                </button>
            </form>
        </div>

        <!-- Summary Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-icon blue">
                        <i class="fas fa-file-contract"></i>
                    </div>
                    <div>
                        <div class="stat-label">T·ªïng s·ªë h·ª£p ƒë·ªìng</div>
                        <div class="stat-value" th:text="${totalContracts}">0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div>
                        <div class="stat-label">Ch·ªù k√Ω</div>
                        <div class="stat-value" th:text="${pendingContracts}">0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div>
                        <div class="stat-label">ƒê√£ k√Ω</div>
                        <div class="stat-value" th:text="${signedContracts}">0</div>
                    </div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-icon gray">
                        <i class="fas fa-archive"></i>
                    </div>
                    <div>
                        <div class="stat-label">ƒê√£ l∆∞u tr·ªØ</div>
                        <div class="stat-value" th:text="${archivedContracts}">0</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="card">
            <h3 style="margin-bottom: 20px; font-size: 18px; font-weight: 600;">Danh S√°ch H·ª£p ƒê·ªìng</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>M√É H·ª¢P ƒê·ªíNG</th>
                            <th>NH√ìM</th>
                            <th>TR·∫†NG TH√ÅI</th>
                            <th>NG√ÄY T·∫†O</th>
                            <th>NG√ÄY K√ù</th>
                            <th style="text-align: center;">H√ÄNH ƒê·ªòNG</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Debug info -->
                        <tr th:if="${contracts == null}">
                            <td colspan="6" class="empty-state" style="color: red;">
                                <i class="fas fa-exclamation-triangle"></i>
                                L·ªói: contracts = null. Ki·ªÉm tra logs ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.
                            </td>
                        </tr>
                        <tr th:if="${contracts != null and contracts.isEmpty()}">
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-file-contract"></i>
                                Kh√¥ng c√≥ h·ª£p ƒë·ªìng n√†o. 
                                <br><small style="color: #64748b;">T·ªïng s·ªë: <span th:text="${totalContracts}">0</span></small>
                            </td>
                        </tr>
                        <tr th:each="contract : ${contracts}">
                            <td>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 40px; height: 40px; background: #f1f5f9; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: #667eea;">
                                        <i class="fas fa-file-contract"></i>
                                    </div>
                                    <div>
                                        <div style="font-weight: 600; color: #1a202c;" th:text="${contract.contractCode}">LC-001</div>
                                        <div style="font-size: 12px; color: #94a3b8;" th:text="'ID: ' + ${contract.contractId}">ID: 1</div>
                                    </div>
                                </div>
                            </td>
                            <td th:text="'Nh√≥m ' + ${contract.groupId}">Nh√≥m 1</td>
                            <td>
                                <span th:if="${contract.contractStatus == 'pending'}" 
                                      class="status-badge status-pending">Ch·ªù k√Ω</span>
                                <span th:if="${contract.contractStatus == 'signed'}" 
                                      class="status-badge status-signed">ƒê√£ k√Ω</span>
                                <span th:if="${contract.contractStatus == 'archived'}" 
                                      class="status-badge status-archived">ƒê√£ l∆∞u tr·ªØ</span>
                                <span th:if="${contract.contractStatus != 'pending' and contract.contractStatus != 'signed' and contract.contractStatus != 'archived'}" 
                                      class="status-badge status-pending" th:text="${contract.contractStatus}">Unknown</span>
                            </td>
                            <td th:text="${contract.creationDate != null ? #temporals.format(contract.creationDate, 'dd/MM/yyyy HH:mm') : 'N/A'}">01/01/2024</td>
                            <td th:text="${contract.signedDate != null ? #temporals.format(contract.signedDate, 'dd/MM/yyyy HH:mm') : 'Ch∆∞a k√Ω'}">Ch∆∞a k√Ω</td>
                            <td style="text-align: center;">
                                <button class="btn-action btn-view" 
                                        th:attr="data-contract-id=${contract.contractId}"
                                        onclick="openViewContractModal(this.getAttribute('data-contract-id'))"
                                        title="Xem chi ti·∫øt">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button th:if="${contract.contractStatus != 'signed' and contract.contractStatus != 'archived'}"
                                        class="btn-action btn-edit" 
                                        th:attr="data-contract-id=${contract.contractId}"
                                        onclick="openEditContractModal(this.getAttribute('data-contract-id'))"
                                        title="Ch·ªânh s·ª≠a">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button th:if="${contract.contractStatus == 'pending'}"
                                        class="btn-action btn-sign" 
                                        th:attr="data-contract-id=${contract.contractId}"
                                        onclick="signContract(this.getAttribute('data-contract-id'))"
                                        title="K√Ω h·ª£p ƒë·ªìng">
                                    <i class="fas fa-signature"></i>
                                </button>
                                <button th:if="${contract.contractStatus != 'archived'}"
                                        class="btn-action btn-archive" 
                                        th:attr="data-contract-id=${contract.contractId}"
                                        onclick="archiveContract(this.getAttribute('data-contract-id'))"
                                        title="L∆∞u tr·ªØ">
                                    <i class="fas fa-archive"></i>
                                </button>
                                <button class="btn-action btn-delete" 
                                        th:data-contract-id="${contract.contractId}"
                                        th:onclick="'openDeleteContractModal(' + ${contract.contractId} + ')'"
                                        title="X√≥a"
                                        type="button">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="pagination">
                <div class="pagination-info">
                    Hi·ªÉn th·ªã <span th:text="${startIndex}">1</span> - <span th:text="${endIndex}">10</span> 
                    trong t·ªïng s·ªë <span th:text="${totalFiltered}">100</span> h·ª£p ƒë·ªìng
                </div>
                <div class="pagination-controls">
                    <a th:if="${currentPage > 1}" 
                       th:href="@{/admin/legal-contracts(page=${currentPage - 1}, size=${pageSize}, searchQuery=${searchQuery}, statusFilter=${statusFilter})}">
                        <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                    </a>
                    <a th:if="${currentPage <= 1}" class="disabled">
                        <i class="fas fa-chevron-left"></i> Tr∆∞·ªõc
                    </a>

                    <th:block th:each="i : ${#numbers.sequence(1, totalPages)}">
                        <a th:if="${i == currentPage}" 
                           class="active"
                           th:text="${i}">1</a>
                        <a th:if="${i != currentPage}" 
                           th:href="@{/admin/legal-contracts(page=${i}, size=${pageSize}, searchQuery=${searchQuery}, statusFilter=${statusFilter})}"
                           th:text="${i}">1</a>
                    </th:block>

                    <a th:if="${currentPage < totalPages}" 
                       th:href="@{/admin/legal-contracts(page=${currentPage + 1}, size=${pageSize}, searchQuery=${searchQuery}, statusFilter=${statusFilter})}">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                    <a th:if="${currentPage >= totalPages}" class="disabled">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Contract Modal -->
    <div id="contractModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">T·∫°o H·ª£p ƒê·ªìng M·ªõi</h2>
                <span class="close" onclick="closeContractModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="contractForm" onsubmit="saveContract(event)">
                    <input type="hidden" id="contractId">
                    
                    <div class="form-group">
                        <label for="contractCode">M√£ h·ª£p ƒë·ªìng <span class="required">*</span></label>
                        <input type="text" id="contractCode" required placeholder="VD: LC-2024-001">
                    </div>

                    <div class="form-group">
                        <label for="groupId">ID Nh√≥m <span class="required">*</span></label>
                        <input type="number" id="groupId" required placeholder="Nh·∫≠p ID nh√≥m">
                    </div>

                    <div class="form-group">
                        <label for="contractStatus">Tr·∫°ng th√°i <span class="required">*</span></label>
                        <select id="contractStatus" required>
                            <option value="pending">Ch·ªù k√Ω</option>
                            <option value="signed">ƒê√£ k√Ω</option>
                            <option value="archived">ƒê√£ l∆∞u tr·ªØ</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeContractModal()">H·ªßy</button>
                <button type="submit" form="contractForm" class="btn-save">L∆∞u</button>
            </div>
        </div>
    </div>

    <!-- View Contract Modal -->
    <div id="viewContractModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Chi Ti·∫øt H·ª£p ƒê·ªìng</h2>
                <span class="close" onclick="closeViewContractModal()">&times;</span>
            </div>
            <div class="modal-body">
                <div id="contractDetails">
                    <p>ƒêang t·∫£i...</p>
                </div>
                <div id="contractHistory" style="margin-top: 24px;">
                    <h4 style="margin-bottom: 12px;">L·ªãch s·ª≠</h4>
                    <div class="history-list" id="historyList">
                        <p>ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeViewContractModal()">ƒê√≥ng</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="modal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h2>X√°c nh·∫≠n x√≥a</h2>
                <span class="close" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a h·ª£p ƒë·ªìng n√†y kh√¥ng?</p>
                <p style="color: #ef4444; font-weight: 600;">H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-cancel" onclick="closeDeleteModal()">H·ªßy</button>
                <button type="button" class="btn-delete-confirm" onclick="confirmDelete()">X√≥a</button>
            </div>
        </div>
    </div>

    <script>
        let currentContractId = null;

        // Event delegation cho n√∫t x√≥a - ƒë·∫£m b·∫£o ho·∫°t ƒë·ªông ngay c·∫£ khi Thymeleaf onclick c√≥ v·∫•n ƒë·ªÅ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîµ [DOMContentLoaded] ƒêang thi·∫øt l·∫≠p event listeners cho n√∫t x√≥a');
            
            // S·ª≠ d·ª•ng event delegation ƒë·ªÉ b·∫Øt s·ª± ki·ªán click tr√™n t·∫•t c·∫£ n√∫t x√≥a
            document.addEventListener('click', function(event) {
                const deleteButton = event.target.closest('.btn-delete');
                if (deleteButton) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    // L·∫•y contract ID t·ª´ data attribute ho·∫∑c t·ª´ Thymeleaf
                    const contractId = deleteButton.getAttribute('data-contract-id') || 
                                      deleteButton.getAttribute('th:data-contract-id');
                    
                    console.log('üîµ [Event Delegation] N√∫t x√≥a ƒë∆∞·ª£c click, Contract ID:', contractId);
                    
                    if (contractId) {
                        openDeleteContractModal(parseInt(contractId));
                    } else {
                        console.error('‚ùå [Event Delegation] Kh√¥ng t√¨m th·∫•y contract ID');
                        alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID h·ª£p ƒë·ªìng');
                    }
                }
            });
            
            console.log('‚úÖ [DOMContentLoaded] Event listeners ƒë√£ ƒë∆∞·ª£c thi·∫øt l·∫≠p');
        });

        function openAddContractModal() {
            document.getElementById('modalTitle').textContent = 'T·∫°o H·ª£p ƒê·ªìng M·ªõi';
            document.getElementById('contractId').value = '';
            document.getElementById('contractCode').value = '';
            document.getElementById('groupId').value = '';
            document.getElementById('contractStatus').value = 'pending';
            document.getElementById('contractModal').style.display = 'block';
        }

        function openEditContractModal(contractId) {
            fetch(`/admin/legal-contracts/api/${contractId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    const contract = data.contract;
                    document.getElementById('modalTitle').textContent = 'Ch·ªânh S·ª≠a H·ª£p ƒê·ªìng';
                    document.getElementById('contractId').value = contract.contractId;
                    document.getElementById('contractCode').value = contract.contractCode || '';
                    document.getElementById('groupId').value = contract.groupId || '';
                    document.getElementById('contractStatus').value = contract.contractStatus || 'pending';
                    document.getElementById('contractModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h·ª£p ƒë·ªìng');
                });
        }

        function openViewContractModal(contractId) {
            fetch(`/admin/legal-contracts/api/${contractId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    const contract = data.contract;
                    const history = data.history || [];
                    
                    const detailsHtml = `
                        <div style="margin-bottom: 16px;">
                            <strong>M√£ h·ª£p ƒë·ªìng:</strong> ${contract.contractCode || 'N/A'}<br>
                            <strong>ID:</strong> ${contract.contractId}<br>
                            <strong>Nh√≥m ID:</strong> ${contract.groupId || 'N/A'}<br>
                            <strong>Tr·∫°ng th√°i:</strong> ${contract.contractStatus || 'N/A'}<br>
                            <strong>Ng√†y t·∫°o:</strong> ${contract.creationDate ? new Date(contract.creationDate).toLocaleString('vi-VN') : 'N/A'}<br>
                            <strong>Ng√†y k√Ω:</strong> ${contract.signedDate ? new Date(contract.signedDate).toLocaleString('vi-VN') : 'Ch∆∞a k√Ω'}
                        </div>
                    `;
                    
                    document.getElementById('contractDetails').innerHTML = detailsHtml;
                    
                    if (history.length > 0) {
                        const historyHtml = history.map(h => `
                            <div class="history-item">
                                <div class="history-action">${h.action || 'N/A'}</div>
                                <div class="history-date">${h.actionDate ? new Date(h.actionDate).toLocaleString('vi-VN') : 'N/A'}</div>
                            </div>
                        `).join('');
                        document.getElementById('historyList').innerHTML = historyHtml;
                    } else {
                        document.getElementById('historyList').innerHTML = '<p style="color: #64748b;">Ch∆∞a c√≥ l·ªãch s·ª≠</p>';
                    }
                    
                    document.getElementById('viewContractModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin h·ª£p ƒë·ªìng');
                });
        }

        function closeContractModal() {
            document.getElementById('contractModal').style.display = 'none';
        }

        function closeViewContractModal() {
            document.getElementById('viewContractModal').style.display = 'none';
        }

        function saveContract(event) {
            event.preventDefault();
            const contractId = document.getElementById('contractId').value;
            const contractData = {
                contractCode: document.getElementById('contractCode').value,
                groupId: parseInt(document.getElementById('groupId').value),
                contractStatus: document.getElementById('contractStatus').value
            };

            const url = contractId 
                ? `/admin/legal-contracts/api/update/${contractId}`
                : '/admin/legal-contracts/api/create';
            const method = contractId ? 'PUT' : 'POST';

            fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(contractData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    closeContractModal();
                    window.location.reload();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u h·ª£p ƒë·ªìng');
            });
        }

        function signContract(contractId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën k√Ω h·ª£p ƒë·ªìng n√†y kh√¥ng?')) {
                return;
            }
            fetch(`/admin/legal-contracts/api/sign/${contractId}`, {
                method: 'PUT'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi k√Ω h·ª£p ƒë·ªìng');
            });
        }

        function archiveContract(contractId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën l∆∞u tr·ªØ h·ª£p ƒë·ªìng n√†y kh√¥ng?')) {
                return;
            }
            fetch(`/admin/legal-contracts/api/archive/${contractId}`, {
                method: 'PUT'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(data.message);
                    window.location.reload();
                } else {
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u tr·ªØ h·ª£p ƒë·ªìng');
            });
        }

        function openDeleteContractModal(contractId) {
            console.log('üîµ [openDeleteContractModal] Contract ID:', contractId);
            if (!contractId) {
                alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID h·ª£p ƒë·ªìng');
                return;
            }
            currentContractId = contractId;
            const modal = document.getElementById('deleteModal');
            if (modal) {
                modal.style.display = 'block';
                console.log('‚úÖ [openDeleteContractModal] Modal ƒë√£ m·ªü');
            } else {
                console.error('‚ùå [openDeleteContractModal] Kh√¥ng t√¨m th·∫•y deleteModal');
                alert('‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y modal x√°c nh·∫≠n x√≥a');
            }
        }

        function closeDeleteModal() {
            document.getElementById('deleteModal').style.display = 'none';
            currentContractId = null;
        }

        function confirmDelete() {
            console.log('üîµ [confirmDelete] H√†m ƒë∆∞·ª£c g·ªçi, currentContractId:', currentContractId);
            
            if (!currentContractId) {
                console.error('‚ùå [confirmDelete] Kh√¥ng c√≥ currentContractId');
                alert('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ID h·ª£p ƒë·ªìng');
                return;
            }
            
            console.log('üîµ [confirmDelete] ƒêang x√≥a h·ª£p ƒë·ªìng ID: ' + currentContractId);
            console.log('üîµ [confirmDelete] URL: /admin/legal-contracts/api/delete/' + currentContractId);
            
            // Disable button ƒë·ªÉ tr√°nh double click
            const deleteBtn = document.querySelector('.btn-delete-confirm');
            if (deleteBtn) {
                deleteBtn.disabled = true;
                deleteBtn.textContent = 'ƒêang x√≥a...';
            }
            
            fetch(`/admin/legal-contracts/api/delete/${currentContractId}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                console.log('üîµ [confirmDelete] Response status: ' + response.status);
                console.log('üîµ [confirmDelete] Response headers:', response.headers);
                
                if (!response.ok) {
                    return response.text().then(text => {
                        console.error('‚ùå [confirmDelete] HTTP Error:', response.status);
                        console.error('‚ùå [confirmDelete] Response body:', text);
                        let errorMessage = `HTTP ${response.status}`;
                        try {
                            const errorData = JSON.parse(text);
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            errorMessage = text || errorMessage;
                        }
                        throw new Error(errorMessage);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('üîµ [confirmDelete] Response data:', JSON.stringify(data, null, 2));
                
                if (data.success === true || data.success === 'true') {
                    console.log('‚úÖ [confirmDelete] X√≥a th√†nh c√¥ng!');
                    alert('‚úÖ ' + (data.message || 'ƒê√£ x√≥a h·ª£p ƒë·ªìng th√†nh c√¥ng!'));
                    closeDeleteModal();
                    // Reload page after a short delay to show the success message
                    setTimeout(() => {
                    window.location.reload();
                    }, 500);
                } else {
                    const errorMsg = data.message || data.error || 'Kh√¥ng th·ªÉ x√≥a h·ª£p ƒë·ªìng. Vui l√≤ng th·ª≠ l·∫°i.';
                    console.error('‚ùå [confirmDelete] Delete failed:', data);
                    alert('‚ùå ' + errorMsg);
                    
                    // Re-enable button
                    if (deleteBtn) {
                        deleteBtn.disabled = false;
                        deleteBtn.textContent = 'X√≥a';
                    }
                }
            })
            .catch(error => {
                console.error('‚ùå [confirmDelete] Error:', error);
                console.error('‚ùå [confirmDelete] Error stack:', error.stack);
                alert('‚ùå C√≥ l·ªói x·∫£y ra khi x√≥a h·ª£p ƒë·ªìng:\n' + error.message + '\n\nVui l√≤ng ki·ªÉm tra console ƒë·ªÉ bi·∫øt th√™m chi ti·∫øt.');
                
                // Re-enable button
                if (deleteBtn) {
                    deleteBtn.disabled = false;
                    deleteBtn.textContent = 'X√≥a';
                }
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const contractModal = document.getElementById('contractModal');
            const viewModal = document.getElementById('viewContractModal');
            const deleteModal = document.getElementById('deleteModal');
            if (event.target == contractModal) {
                closeContractModal();
            }
            if (event.target == viewModal) {
                closeViewContractModal();
            }
            if (event.target == deleteModal) {
                closeDeleteModal();
            }
        }
    </script>
</body>
</html>

