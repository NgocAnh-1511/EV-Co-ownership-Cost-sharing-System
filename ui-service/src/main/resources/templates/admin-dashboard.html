<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - CarShare Manager</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link th:href="@{/css/admin-dashboard.css}" rel="stylesheet">
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <aside class="admin-sidebar">
            <div class="admin-brand">
                <i class="fas fa-shield-halved"></i>
                <span>ADMIN PANEL</span>
            </div>
            
            <nav class="admin-nav">
                <a href="#overview" class="nav-link active" data-section="overview">
                    <i class="fas fa-chart-line"></i>
                    <span>Tổng quan</span>
                </a>
                <a href="#cost-management" class="nav-link" data-section="cost-management">
                    <i class="fas fa-money-bill-wave"></i>
                    <span>Quản lý chi phí</span>
                </a>
                <a href="#auto-split" class="nav-link" data-section="auto-split">
                    <i class="fas fa-calculator"></i>
                    <span>Chia tự động</span>
                </a>
                <a href="#payment-tracking" class="nav-link" data-section="payment-tracking">
                    <i class="fas fa-credit-card"></i>
                    <span>Theo dõi thanh toán</span>
                </a>
                <a href="#group-management" class="nav-link" data-section="group-management">
                    <i class="fas fa-users"></i>
                    <span>Quản lý nhóm</span>
                </a>
                <a href="#fund-management" class="nav-link" data-section="fund-management">
                    <i class="fas fa-wallet"></i>
                    <span>Quản lý quỹ chung</span>
                </a>
            </nav>
            
            <div class="admin-user">
                <div class="user-avatar">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="user-info">
                    <div class="user-name">Admin</div>
                    <div class="user-role">Quản trị viên</div>
                </div>
                <a href="/" class="logout-btn" title="Đăng xuất">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="admin-main">
            <!-- Header -->
            <header class="admin-header">
                <div class="header-left">
                    <h1 id="page-title">Tổng quan</h1>
                    <p class="header-subtitle">Quản lý hệ thống chia sẻ chi phí xe điện</p>
                </div>
                <div class="header-right">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Tìm kiếm...">
                    </div>
                    <button class="btn-notifications">
                        <i class="fas fa-bell"></i>
                        <span class="badge">3</span>
                    </button>
                </div>
            </header>

            <!-- Content Sections -->
            <div class="admin-content">
                
                <!-- OVERVIEW SECTION -->
                <section id="overview-section" class="content-section active">
                    <!-- Time Period Filter -->
                    <div class="time-filter-bar" style="margin-bottom: 1.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="btn-time-filter active" data-period="today" onclick="setTimePeriod('today')">
                            <i class="fas fa-calendar-day"></i> Hôm nay
                        </button>
                        <button class="btn-time-filter" data-period="week" onclick="setTimePeriod('week')">
                            <i class="fas fa-calendar-week"></i> Tuần này
                        </button>
                        <button class="btn-time-filter" data-period="month" onclick="setTimePeriod('month')">
                            <i class="fas fa-calendar-alt"></i> Tháng này
                        </button>
                        <button class="btn-time-filter" data-period="quarter" onclick="setTimePeriod('quarter')">
                            <i class="fas fa-calendar"></i> Quý này
                        </button>
                        <button class="btn-time-filter" data-period="year" onclick="setTimePeriod('year')">
                            <i class="fas fa-calendar-check"></i> Năm này
                        </button>
                        <button class="btn-time-filter" data-period="custom" onclick="showCustomDateRange()">
                            <i class="fas fa-calendar-range"></i> Tùy chọn
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div class="quick-actions" style="margin-bottom: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openCreateCostModal()">
                            <i class="fas fa-plus"></i> Tạo chi phí mới
                        </button>
                        <button class="btn btn-success" onclick="switchSection('auto-split')">
                            <i class="fas fa-calculator"></i> Chia tự động
                        </button>
                        <button class="btn btn-secondary" onclick="switchSection('group-management')">
                            <i class="fas fa-users"></i> Quản lý nhóm
                        </button>
                        <button class="btn btn-info" onclick="exportOverviewReport()">
                            <i class="fas fa-file-excel"></i> Xuất báo cáo
                        </button>
                    </div>

                    <!-- Alerts Section -->
                    <div id="alerts-section" class="alerts-container" style="margin-bottom: 1.5rem;">
                        <!-- Alerts will be loaded here -->
                    </div>

                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng chi phí</div>
                                <div class="stat-value" id="total-cost">0 ₫</div>
                                <div class="stat-trend" id="total-cost-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Đã thanh toán</div>
                                <div class="stat-value" id="paid-amount">0 ₫</div>
                                <div class="stat-trend" id="paid-amount-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Chưa thanh toán</div>
                                <div class="stat-value" id="pending-amount">0 ₫</div>
                                <div class="stat-trend" id="pending-amount-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card danger">
                            <div class="stat-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Thanh toán quá hạn</div>
                                <div class="stat-value" id="overdue-amount">0 ₫</div>
                                <div class="stat-trend" id="overdue-count">
                                    <i class="fas fa-info-circle"></i> <span id="overdue-count-value">0</span> khoản
                                </div>
                            </div>
                        </div>

                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng số thành viên</div>
                                <div class="stat-value" id="total-members">0</div>
                                <div class="stat-trend" id="total-members-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card secondary">
                            <div class="stat-icon">
                                <i class="fas fa-layer-group"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng số nhóm</div>
                                <div class="stat-value" id="total-groups">0</div>
                                <div class="stat-trend" id="total-groups-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-car"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng số xe</div>
                                <div class="stat-value" id="total-vehicles">0</div>
                                <div class="stat-trend" id="total-vehicles-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>

                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tỷ lệ thanh toán</div>
                                <div class="stat-value" id="payment-rate">0%</div>
                                <div class="stat-trend" id="payment-rate-trend">
                                    <i class="fas fa-minus"></i> -
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts Row -->
                    <div class="charts-row">
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Chi phí theo tháng</h3>
                                <select id="year-select" onchange="updateMonthlyChart()">
                                    <option value="2025">2025</option>
                                    <option value="2024">2024</option>
                                    <option value="2023">2023</option>
                                </select>
                            </div>
                            <div class="card-body">
                                <canvas id="monthly-chart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Phân loại chi phí</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="category-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Charts Row -->
                    <div class="charts-row" style="margin-top: 1.5rem;">
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Chi phí theo loại (Bar Chart)</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="category-bar-chart"></canvas>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Tỷ lệ thanh toán</h3>
                            </div>
                            <div class="card-body">
                                <canvas id="payment-rate-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Top Lists Row -->
                    <div class="charts-row" style="margin-top: 1.5rem;">
                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Top 5 chi phí cao nhất</h3>
                            </div>
                            <div class="card-body">
                                <div id="top-costs-list" class="top-list">
                                    <!-- Top costs will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <div class="chart-card">
                            <div class="card-header">
                                <h3>Top 5 thành viên chưa thanh toán</h3>
                            </div>
                            <div class="card-body">
                                <div id="top-unpaid-users-list" class="top-list">
                                    <!-- Top unpaid users will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="recent-activities">
                        <div class="card-header">
                            <h3>Hoạt động gần đây</h3>
                            <a href="#" class="view-all" onclick="switchSection('cost-management'); return false;">Xem tất cả</a>
                        </div>
                        <div class="activity-list" id="activity-list">
                            <!-- Activities will be loaded here -->
                        </div>
                    </div>
                </section>

                <!-- Custom Date Range Modal -->
                <div id="custom-date-modal" class="modal">
                    <div class="modal-header">
                        <h3>Chọn khoảng thời gian</h3>
                        <button class="modal-close" onclick="closeCustomDateModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label>Từ ngày</label>
                            <input type="date" id="custom-date-from" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Đến ngày</label>
                            <input type="date" id="custom-date-to" class="form-control">
                        </div>
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeCustomDateModal()">Hủy</button>
                        <button type="button" class="btn btn-primary" onclick="applyCustomDateRange()">Áp dụng</button>
                    </div>
                </div>

                <!-- COST MANAGEMENT SECTION -->
                <section id="cost-management-section" class="content-section">
                    <div class="section-header">
                        <button class="btn btn-primary" id="btn-create-cost" onclick="openCreateCostModal()">
                            <i class="fas fa-plus"></i> Tạo chi phí mới
                        </button>
                        <div class="filter-group">
                            <select id="cost-type-filter" onchange="applyCostFilters()">
                                <option value="">Tất cả loại</option>
                                <option value="ElectricCharge">Phí sạc điện</option>
                                <option value="Maintenance">Bảo dưỡng</option>
                                <option value="Insurance">Bảo hiểm</option>
                                <option value="Inspection">Đăng kiểm</option>
                                <option value="Cleaning">Vệ sinh</option>
                                <option value="Other">Khác</option>
                            </select>
                            <select id="cost-status-filter" onchange="applyCostFilters()">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chưa chia</option>
                                <option value="SHARED">Đã chia</option>
                            </select>
                            <input type="text" id="cost-search-input" placeholder="Tìm kiếm..." 
                                   style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                            <button class="btn btn-secondary" onclick="applyCostFilters()">
                                <i class="fas fa-search"></i> Tìm
                            </button>
                        </div>
                    </div>

                    <div class="data-table">
                        <table id="costs-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Vehicle ID</th>
                                    <th>Loại chi phí</th>
                                    <th>Số tiền</th>
                                    <th>Ngày tạo</th>
                                    <th>Đã chia</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="costs-tbody">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- AUTO SPLIT SECTION -->
                <section id="auto-split-section" class="content-section">
                    <div class="split-form-card">
                        <h3>Tạo chi phí và tự động chia</h3>
                        
                        <form id="auto-split-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Nhóm/Xe</label>
                                    <select id="group-select" required>
                                        <option value="">-- Chọn nhóm --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Loại chi phí</label>
                                    <select id="cost-type" required>
                                        <option value="ElectricCharge">Phí sạc điện</option>
                                        <option value="Maintenance">Bảo dưỡng</option>
                                        <option value="Insurance">Bảo hiểm</option>
                                        <option value="Inspection">Đăng kiểm</option>
                                        <option value="Cleaning">Vệ sinh</option>
                                        <option value="Other">Khác</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label>Số tiền</label>
                                    <input type="number" id="amount" placeholder="VD: 500000" required>
                                </div>
                                <div class="form-group">
                                    <label>Phương thức chia</label>
                                    <select id="split-method" required>
                                        <option value="BY_OWNERSHIP">Theo tỷ lệ sở hữu</option>
                                        <option value="BY_USAGE">Theo km đã chạy</option>
                                        <option value="EQUAL">Chia đều</option>
                                    </select>
                                </div>
                            </div>

                            <div class="form-group" id="usage-period" style="display: none;">
                                <label>Tháng/Năm (cho phương thức theo km)</label>
                                <div class="form-row">
                                    <select id="month">
                                        <option value="1">Tháng 1</option>
                                        <option value="2">Tháng 2</option>
                                        <option value="3">Tháng 3</option>
                                        <option value="4">Tháng 4</option>
                                        <option value="5">Tháng 5</option>
                                        <option value="6">Tháng 6</option>
                                        <option value="7">Tháng 7</option>
                                        <option value="8">Tháng 8</option>
                                        <option value="9">Tháng 9</option>
                                        <option value="10">Tháng 10</option>
                                        <option value="11">Tháng 11</option>
                                        <option value="12">Tháng 12</option>
                                    </select>
                                    <input type="number" id="year" placeholder="2025" value="2025">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Mô tả</label>
                                <textarea id="description" rows="3" placeholder="Mô tả chi tiết về khoản chi..."></textarea>
                            </div>

                            <div class="form-actions">
                                <button type="button" class="btn btn-secondary" id="btn-preview">
                                    <i class="fas fa-eye"></i> Xem trước
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Tạo và chia tự động
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Preview Result -->
                    <div id="preview-result" class="preview-card" style="display: none;">
                        <h3>Kết quả chia chi phí</h3>
                        <div id="preview-content"></div>
                    </div>
                </section>

                <!-- PAYMENT TRACKING SECTION -->
                <section id="payment-tracking-section" class="content-section">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-receipt"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng thanh toán</div>
                                <div class="stat-value" id="total-payments">0</div>
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Đã thanh toán</div>
                                <div class="stat-value" id="paid-count">0</div>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Chờ thanh toán</div>
                                <div class="stat-value" id="pending-count">0</div>
                            </div>
                        </div>

                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng số tiền</div>
                                <div class="stat-value" id="total-amount">0đ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters -->
                    <div class="section-header">
                        <div class="filter-group">
                            <select id="payment-status-filter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chờ thanh toán</option>
                                <option value="PAID">Đã thanh toán</option>
                                <option value="OVERDUE">Quá hạn</option>
                            </select>
                            <input type="date" id="payment-date-from" placeholder="Từ ngày">
                            <input type="date" id="payment-date-to" placeholder="Đến ngày">
                            <input type="text" id="payment-search" placeholder="Tìm kiếm...">
                            <button class="btn btn-primary" id="btn-filter-payments">
                                <i class="fas fa-search"></i> Tìm kiếm
                            </button>
                            <button class="btn btn-secondary" id="btn-reset-filters">
                                <i class="fas fa-redo"></i> Đặt lại
                            </button>
                        </div>
                        <button class="btn btn-success" id="btn-export-payments">
                            <i class="fas fa-file-excel"></i> Xuất Excel
                        </button>
                    </div>

                    <div class="data-table">
                        <table id="payments-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User ID</th>
                                    <th>Chi phí</th>
                                    <th>Số tiền</th>
                                    <th>Phương thức</th>
                                    <th>Mã GD</th>
                                    <th>Ngày</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="payments-tbody">
                                <tr>
                                    <td colspan="9" style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>

                <!-- GROUP MANAGEMENT SECTION -->
                <section id="group-management-section" class="content-section">
                    <div class="section-header">
                        <button class="btn btn-primary" id="btn-create-group">
                            <i class="fas fa-plus"></i> Tạo nhóm mới
                        </button>
                    </div>

                    <div class="groups-grid" id="groups-grid">
                        <!-- Groups will be loaded here -->
                    </div>
                </section>

                <!-- FUND MANAGEMENT SECTION -->
                <section id="fund-management-section" class="content-section">
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng số dư quỹ</div>
                                <div class="stat-value" id="total-fund-balance">0 ₫</div>
                                <div class="stat-trend" id="total-fund-balance-trend">
                                    <i class="fas fa-info-circle"></i> <span id="total-funds-count">0</span> quỹ
                                </div>
                            </div>
                        </div>

                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-down"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng nạp tiền</div>
                                <div class="stat-value" id="total-deposits">0 ₫</div>
                                <div class="stat-trend" id="total-deposits-trend">
                                    <i class="fas fa-calendar-alt"></i> Tháng này
                                </div>
                            </div>
                        </div>

                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-arrow-up"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Tổng rút tiền</div>
                                <div class="stat-value" id="total-withdraws">0 ₫</div>
                                <div class="stat-trend" id="total-withdraws-trend">
                                    <i class="fas fa-calendar-alt"></i> Tháng này
                                </div>
                            </div>
                        </div>

                        <div class="stat-card danger">
                            <div class="stat-icon">
                                <i class="fas fa-hourglass-half"></i>
                            </div>
                            <div class="stat-details">
                                <div class="stat-label">Yêu cầu chờ duyệt</div>
                                <div class="stat-value" id="pending-requests-count">0</div>
                                <div class="stat-trend" id="pending-requests-trend">
                                    <i class="fas fa-info-circle"></i> Cần xử lý
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Filters and Actions -->
                    <div class="section-header">
                        <div class="filter-group">
                            <select id="fund-group-filter" onchange="loadFundManagementData()">
                                <option value="">Tất cả nhóm</option>
                            </select>
                            <select id="fund-status-filter" onchange="loadFundManagementData()">
                                <option value="">Tất cả trạng thái</option>
                                <option value="ACTIVE">Hoạt động</option>
                                <option value="INACTIVE">Không hoạt động</option>
                            </select>
                            <input type="text" id="fund-search-input" placeholder="Tìm kiếm nhóm..." 
                                   style="padding: 0.5rem; border: 1px solid var(--border); border-radius: 6px;">
                            <button class="btn btn-secondary" onclick="loadFundManagementData()">
                                <i class="fas fa-search"></i> Tìm
                            </button>
                        </div>
                        <button class="btn btn-success" onclick="exportFundReport()">
                            <i class="fas fa-file-excel"></i> Xuất báo cáo
                            </button>
                        </div>

                    <!-- Funds List -->
                    <div class="data-table">
                        <table id="funds-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nhóm</th>
                                    <th>Số dư hiện tại</th>
                                    <th>Tổng nạp</th>
                                    <th>Tổng rút</th>
                                    <th>Giao dịch</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="funds-tbody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 2rem;">
                                        <i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pending Requests Section -->
                    <div class="pending-requests-section" style="margin-top: 2rem;">
                        <div class="card-header">
                            <h3><i class="fas fa-hourglass-half"></i> Yêu cầu rút tiền chờ duyệt</h3>
                            <button class="btn btn-secondary btn-sm" onclick="loadPendingWithdrawRequests()">
                                <i class="fas fa-sync"></i> Làm mới
                            </button>
                        </div>
                        <div id="pending-requests-list" class="pending-requests-list">
                            <!-- Pending requests will be loaded here -->
                        </div>
                    </div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay"></div>
    
    <!-- Cost CRUD Modals -->
    <div id="cost-modal" class="modal">
        <div class="modal-header">
            <h3 id="cost-modal-title">Chi tiết chi phí</h3>
            <button class="modal-close" onclick="closeCostModal()">&times;</button>
        </div>
        <div class="modal-body" id="cost-modal-body">
            <!-- Content loaded dynamically -->
        </div>
        <div class="modal-actions" id="cost-modal-actions">
            <button type="button" class="btn btn-secondary" onclick="closeCostModal()">Đóng</button>
        </div>
    </div>

    <!-- Cost Create/Edit Modal -->
    <div id="cost-form-modal" class="modal">
        <div class="modal-header">
            <h3 id="cost-form-modal-title">Tạo chi phí mới</h3>
            <button class="modal-close" onclick="closeCostFormModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="cost-form">
                <input type="hidden" id="cost-form-id">
                
                <div class="form-group">
                    <label for="cost-vehicle-id">Vehicle ID <span style="color: red;">*</span></label>
                    <input type="number" id="cost-vehicle-id" class="form-control" required placeholder="Nhập ID xe">
                    <small style="color: var(--text-light);">ID của xe liên quan đến chi phí này</small>
                </div>

                <div class="form-group">
                    <label for="cost-type-select">Loại chi phí <span style="color: red;">*</span></label>
                    <select id="cost-type-select" class="form-control" required>
                        <option value="">-- Chọn loại chi phí --</option>
                        <option value="ElectricCharge">Sạc điện</option>
                        <option value="Maintenance">Bảo dưỡng</option>
                        <option value="Insurance">Bảo hiểm</option>
                        <option value="Inspection">Đăng kiểm</option>
                        <option value="Cleaning">Vệ sinh</option>
                        <option value="Other">Khác</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="cost-amount">Số tiền (VNĐ) <span style="color: red;">*</span></label>
                    <input type="number" id="cost-amount" class="form-control" required 
                           placeholder="VD: 500000" min="0" step="0.01">
                    <small style="color: var(--text-light);">Nhập số tiền chi phí</small>
                </div>

                <div class="form-group">
                    <label for="cost-description">Mô tả</label>
                    <textarea id="cost-description" class="form-control" rows="3" 
                              placeholder="Nhập mô tả chi tiết về chi phí (tùy chọn)"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCostFormModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Cost Split Modal -->
    <div id="cost-split-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="cost-split-modal-title">Phân chia chi phí</h3>
            <button class="modal-close" onclick="closeCostSplitModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="cost-split-info" style="background: var(--light); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                <!-- Cost info will be loaded here -->
            </div>

            <form id="cost-split-form">
                <input type="hidden" id="split-cost-id">
                
                <div class="form-group">
                    <label for="split-method-select">Phương thức chia <span style="color: red;">*</span></label>
                    <select id="split-method-select" class="form-control" required>
                        <option value="">-- Chọn phương thức --</option>
                        <option value="BY_OWNERSHIP">Theo tỷ lệ sở hữu</option>
                        <option value="BY_USAGE">Theo km đã chạy</option>
                        <option value="EQUAL">Chia đều</option>
                        <option value="CUSTOM">Tùy chỉnh (nhập % thủ công)</option>
                    </select>
                </div>

                <div class="form-group" id="split-group-container" style="display: none;">
                    <label for="split-group-id">Nhóm <span style="color: red;">*</span></label>
                    <select id="split-group-id" class="form-control">
                        <option value="">-- Chọn nhóm --</option>
                    </select>
                </div>

                <div class="form-group" id="split-usage-period" style="display: none;">
                    <label>Tháng/Năm (cho phương thức theo km)</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <select id="split-month" class="form-control">
                            <option value="1">Tháng 1</option>
                            <option value="2">Tháng 2</option>
                            <option value="3">Tháng 3</option>
                            <option value="4">Tháng 4</option>
                            <option value="5">Tháng 5</option>
                            <option value="6">Tháng 6</option>
                            <option value="7">Tháng 7</option>
                            <option value="8">Tháng 8</option>
                            <option value="9">Tháng 9</option>
                            <option value="10">Tháng 10</option>
                            <option value="11">Tháng 11</option>
                            <option value="12">Tháng 12</option>
                        </select>
                        <input type="number" id="split-year" class="form-control" placeholder="Năm" 
                               value="2025" min="2020" max="2030">
                    </div>
                </div>

                <div id="split-custom-container" style="display: none;">
                    <div class="form-group">
                        <label>Danh sách thành viên và phần trăm</label>
                        <div id="split-members-list">
                            <!-- Custom split members will be added here -->
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm" onclick="addCustomSplitMember()">
                            <i class="fas fa-plus"></i> Thêm thành viên
                        </button>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="previewCostSplit()">
                        <i class="fas fa-eye"></i> Xem trước
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeCostSplitModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check"></i> Lưu phân chia
                    </button>
                </div>
            </form>

            <!-- Preview Section -->
            <div id="split-preview-section" style="display: none; margin-top: 2rem; padding: 1.5rem; background: var(--light); border-radius: 8px;">
                <h4 style="margin-bottom: 1rem; color: var(--primary);">
                    <i class="fas fa-eye"></i> Xem trước phân chia
                </h4>
                <div id="split-preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Group Create/Edit Modal -->
    <div id="group-modal" class="modal">
        <div class="modal-header">
            <h3 id="group-modal-title">Tạo nhóm mới</h3>
            <button class="modal-close" onclick="closeGroupModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="group-form">
                <input type="hidden" id="group-id">
                
                <div class="form-group">
                    <label for="group-name">Tên nhóm <span style="color: red;">*</span></label>
                    <input type="text" id="group-name" class="form-control" required placeholder="Nhập tên nhóm">
                </div>

                <div class="form-group">
                    <label for="group-admin">Admin ID <span style="color: red;">*</span></label>
                    <input type="number" id="group-admin" class="form-control" required placeholder="Nhập ID người quản lý">
                </div>

                <div class="form-group">
                    <label for="group-vehicle">Vehicle ID</label>
                    <input type="number" id="group-vehicle" class="form-control" placeholder="Nhập ID xe (tùy chọn)">
                </div>

                <div class="form-group">
                    <label for="group-status">Trạng thái</label>
                    <select id="group-status" class="form-control">
                        <option value="Active">Hoạt động</option>
                        <option value="Inactive">Không hoạt động</option>
                    </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeGroupModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Detail Modal -->
    <div id="group-detail-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="group-detail-title">Chi tiết nhóm</h3>
            <button class="modal-close" onclick="closeGroupDetailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="group-detail-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Member Management Modal -->
    <div id="member-modal" class="modal">
        <div class="modal-header">
            <h3 id="member-modal-title">Thêm thành viên</h3>
            <button class="modal-close" onclick="closeMemberModal()">&times;</button>
        </div>
        <div class="modal-body">
            <form id="member-form">
                <input type="hidden" id="member-group-id">
                <input type="hidden" id="member-id">
                
                <div class="form-group">
                    <label for="member-user-id">User ID <span style="color: red;">*</span></label>
                    <input type="number" id="member-user-id" class="form-control" required placeholder="Nhập ID người dùng">
                </div>

                <div class="form-group">
                    <label for="member-role">Vai trò</label>
                    <select id="member-role" class="form-control">
                        <option value="Member">Thành viên</option>
                        <option value="Admin">Quản trị viên</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="member-ownership">Tỷ lệ sở hữu (%)</label>
                    <input type="number" id="member-ownership" class="form-control" min="0" max="100" step="0.01" value="0" placeholder="Nhập % sở hữu">
                    <small style="color: var(--text-light);">Dùng cho phương thức chia theo sở hữu</small>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeMemberModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="payment-details-modal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3><i class="fas fa-info-circle"></i> Chi tiết thanh toán</h3>
                <button class="close-btn" onclick="closePaymentDetailsModal()">&times;</button>
            </div>
            <div class="modal-body" id="payment-details-body">
                <!-- Content will be dynamically loaded -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePaymentDetailsModal()">Đóng</button>
            </div>
        </div>
    </div>

    <!-- Confirm Payment Modal -->
    <div id="confirm-payment-modal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3><i class="fas fa-check-circle"></i> Xác nhận thanh toán</h3>
                <button class="close-btn" onclick="closeConfirmPaymentModal()">&times;</button>
            </div>
            <form id="confirm-payment-form">
                <div class="modal-body">
                    <p style="margin-bottom: 1.5rem;">Bạn có chắc chắn muốn xác nhận thanh toán này?</p>
                    
                    <div class="info-box" style="background: var(--card-bg); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>User ID:</strong>
                            <span id="confirm-user-id">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <strong>Số tiền:</strong>
                            <span id="confirm-amount" style="color: var(--primary); font-weight: bold;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <strong>Mã giao dịch:</strong>
                            <span id="confirm-transaction-code">-</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirm-note">Ghi chú (tùy chọn)</label>
                        <textarea id="confirm-note" class="form-control" rows="3" placeholder="Thêm ghi chú về thanh toán..."></textarea>
                    </div>

                    <input type="hidden" id="confirm-payment-id">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeConfirmPaymentModal()">Hủy</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> Xác nhận
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Payment Modal -->
    <div id="edit-payment-modal" class="modal">
        <div class="modal-content" style="max-width: 600px; display: flex; flex-direction: column; max-height: 90vh;">
            <div class="modal-header" style="flex-shrink: 0;">
                <h3><i class="fas fa-edit"></i> Chỉnh sửa thanh toán</h3>
                <button class="close-btn" onclick="closeEditPaymentModal()">&times;</button>
            </div>
            <form id="edit-payment-form" style="display: flex; flex-direction: column; flex: 1; overflow: hidden; min-height: 0;">
                <div class="modal-body">
                    <input type="hidden" id="edit-payment-id">
                    
                    <div class="form-group">
                        <label for="edit-user-id">User ID <span style="color: red;">*</span></label>
                        <input type="number" id="edit-user-id" class="form-control" required placeholder="Nhập User ID">
                    </div>

                    <div class="form-group">
                        <label for="edit-cost-id">Cost ID <span style="color: red;">*</span></label>
                        <input type="number" id="edit-cost-id" class="form-control" required placeholder="Nhập Cost ID">
                    </div>

                    <div class="form-group">
                        <label for="edit-amount">Số tiền <span style="color: red;">*</span></label>
                        <input type="number" id="edit-amount" class="form-control" required placeholder="Nhập số tiền" step="0.01">
                    </div>

                    <div class="form-group">
                        <label for="edit-method">Phương thức thanh toán</label>
                        <select id="edit-method" class="form-control">
                            <option value="">-- Chọn phương thức --</option>
                            <option value="BANKING">Chuyển khoản</option>
                            <option value="CASH">Tiền mặt</option>
                            <option value="EWALLET">Ví điện tử</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="edit-transaction-code">Mã giao dịch</label>
                        <input type="text" id="edit-transaction-code" class="form-control" placeholder="Nhập mã giao dịch">
                    </div>

                    <div class="form-group">
                        <label for="edit-payment-date">Ngày thanh toán</label>
                        <input type="date" id="edit-payment-date" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="edit-status">Trạng thái</label>
                        <select id="edit-status" class="form-control">
                            <option value="PENDING">Chờ thanh toán</option>
                            <option value="PAID">Đã thanh toán</option>
                            <option value="OVERDUE">Quá hạn</option>
                            <option value="CANCELLED">Đã hủy</option>
                        </select>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditPaymentModal()">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Print Invoice Modal -->
    <div id="invoice-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3><i class="fas fa-file-invoice"></i> Hóa đơn thanh toán</h3>
                <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="invoice-content" style="padding: 2rem; background: white; color: #000;">
                    <!-- Invoice content will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeInvoiceModal()">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="printInvoice()">
                    <i class="fas fa-print"></i> In hóa đơn
                </button>
                <button type="button" class="btn btn-success" onclick="downloadInvoicePDF()">
                    <i class="fas fa-download"></i> Tải PDF
                </button>
            </div>
        </div>
    </div>

    <!-- Fund Detail Modal -->
    <div id="fund-detail-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="fund-detail-title">Chi tiết quỹ</h3>
            <button class="modal-close" onclick="closeFundDetailModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="fund-detail-content">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

    <!-- Fund Transaction History Modal -->
    <div id="fund-transactions-modal" class="modal" style="max-width: 900px;">
        <div class="modal-header">
            <h3 id="fund-transactions-title">Lịch sử giao dịch</h3>
            <button class="modal-close" onclick="closeFundTransactionsModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="filter-group" style="margin-bottom: 1rem;">
                <select id="transaction-type-filter" onchange="loadFundTransactions()">
                    <option value="">Tất cả loại</option>
                    <option value="DEPOSIT">Nạp tiền</option>
                    <option value="WITHDRAW">Rút tiền</option>
                </select>
                <select id="transaction-status-filter" onchange="loadFundTransactions()">
                    <option value="">Tất cả trạng thái</option>
                    <option value="APPROVED">Đã duyệt</option>
                    <option value="PENDING">Chờ duyệt</option>
                    <option value="REJECTED">Từ chối</option>
                </select>
            </div>
            <div id="fund-transactions-content">
                <!-- Transactions will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Approve/Reject Withdraw Request Modal -->
    <div id="withdraw-request-modal" class="modal">
        <div class="modal-header">
            <h3 id="withdraw-request-title">Xử lý yêu cầu rút tiền</h3>
            <button class="modal-close" onclick="closeWithdrawRequestModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div id="withdraw-request-content">
                <!-- Request details will be loaded here -->
            </div>
            <form id="withdraw-request-form">
                <input type="hidden" id="request-id">
                <input type="hidden" id="request-action">
                <div class="form-group">
                    <label for="request-note">Ghi chú (tùy chọn)</label>
                    <textarea id="request-note" class="form-control" rows="3" placeholder="Nhập ghi chú về quyết định..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeWithdrawRequestModal()">Hủy</button>
                    <button type="button" class="btn btn-danger" onclick="rejectWithdrawRequest()">
                        <i class="fas fa-times"></i> Từ chối
                    </button>
                    <button type="button" class="btn btn-success" onclick="approveWithdrawRequest()">
                        <i class="fas fa-check"></i> Phê duyệt
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script th:src="@{/js/admin-dashboard.js}"></script>
</body>
</html>

