<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VehicleManager - Qu·∫£n L√Ω D·ªãch V·ª• Xe</title>
    <link rel="stylesheet" th:href="@{/css/vehicle-manager.css}">
    <link rel="stylesheet" th:href="@{/css/sidebar.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>

<body>
<div class="admin-container">
    <!-- Sidebar -->
    <div th:replace="fragments/sidebar :: sidebar"></div>


    <!-- Main Content -->
    <main class="main-content">
        <!-- Header -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h1 style="margin: 0; font-size: 24px; font-weight: 600; color: #1E293B;">Qu·∫£n L√Ω C√°c D·ªãch V·ª• Xe</h1>
                <p style="margin: 8px 0 0 0; color: #64748B; font-size: 14px;">Qu·∫£n l√Ω d·ªãch v·ª• b·∫£o d∆∞·ª°ng, ki·ªÉm tra v√† s·ª≠a ch·ªØa cho xe</p>
            </div>
            <button type="button" class="btn-add-new-service" onclick="openAddNewServiceModal()" 
                    style="background: #10B981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <i class="fas fa-plus-circle"></i> Th√™m D·ªãch V·ª• M·ªõi
            </button>
        </div>


        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card total">
                <div class="stat-icon"><i class="fas fa-car"></i></div>
                <div class="stat-info">
                    <h3>T·ªïng s·ªë xe</h3>
                    <span class="stat-number" th:text="${totalVehicles}">24</span>
                </div>
            </div>
            <div class="stat-card maintenance">
                <div class="stat-icon"><i class="fas fa-tools"></i></div>
                <div class="stat-info">
                    <h3>B·∫£o d∆∞·ª°ng</h3>
                    <span class="stat-number" th:text="${maintenanceVehicles}">6</span>
                </div>
            </div>
            <div class="stat-card inspection">
                <div class="stat-icon"><i class="fas fa-search"></i></div>
                <div class="stat-info">
                    <h3>Ki·ªÉm tra</h3>
                    <span class="stat-number" th:text="${inspectionVehicles}">0</span>
                </div>
            </div>
            <div class="stat-card broken">
                <div class="stat-icon"><i class="fas fa-exclamation-triangle"></i></div>
                <div class="stat-info">
                    <h3>S·ª≠a ch·ªØa</h3>
                    <span class="stat-number" th:text="${brokenVehicles}">2</span>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section">
            <div class="filter-card">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>T√¨m ki·∫øm xe...</label>
                        <input type="text" th:value="${searchQuery}" placeholder="T√¨m ki·∫øm xe...">
                    </div>
                    <div class="filter-group">
                        <label>L·ªçc theo d·ªãch v·ª•</label>
                        <select id="serviceFilter" th:value="${serviceFilter}">
                            <option value="all">T·∫•t c·∫£ d·ªãch v·ª•</option>
                            <option value="maintenance">B·∫£o d∆∞·ª°ng</option>
                            <option value="inspection">Ki·ªÉm tra</option>
                            <option value="repair">S·ª≠a ch·ªØa</option>
                        </select>
                    </div>
                    <button type="button" class="btn-filter" id="btnFilter" onclick="applyFilter()">
                        <i class="fas fa-filter"></i> L·ªçc
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Section -->
        <div class="table-section">
            <div class="table-header">
                <h3>Danh S√°ch Xe</h3>
            </div>

            <div class="table-container">
                <table class="vehicle-table">
                    <thead>
                    <tr>
                        <th>T√äN XE</th>
                        <th>BI·ªÇN S·ªê</th>
                        <th>LO·∫†I XE</th>
                        <th>D·ªäCH V·ª§ ƒêANG CH·ªú</th>
                        <th>TR·∫†NG TH√ÅI</th>
                        <th>NG√ÄY Y√äU C·∫¶U</th>
                        <th>H√ÄNH ƒê·ªòNG</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="vehicle : ${vehicles}" th:attr="data-vehicle-id=${vehicle.vehicleId}">
                        <td>
                            <div class="vehicle-info">
                                <div class="vehicle-icon" th:class="${vehicle.iconClass}"></div>
                                <div>
                                    <div class="vehicle-name" th:text="${vehicle.name}">Toyota Camry 2023</div>
                                    <div class="vehicle-type" th:text="${vehicle.typeDetail}">Sedan Camry 2023</div>
                                </div>
                            </div>
                        </td>
                        <td th:text="${vehicle.plateNumber}">30A-12345</td>
                        <td th:text="${vehicle.category}">Sedan</td>
                        <td>
                            <div th:if="${vehicle.services != null and !vehicle.services.isEmpty()}">
                                <div th:each="service : ${vehicle.services}">
                                    <span class="status" th:class="'status-' + ${service.statusClass}"
                                          th:text="${service.serviceName}">B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥</span>
                                    <span class="service-status" th:text="'(' + ${service.status} + ')'">(pending)</span>
                                </div>
                            </div>
                            <span th:if="${vehicle.services == null or vehicle.services.isEmpty()}" class="status status-available">
                                Kh√¥ng c√≥ d·ªãch v·ª•
                            </span>
                        </td>
                        <td>
                            <span th:if="${vehicle.overallStatus == 'pending'}" class="status-badge status-pending">
                                <i class="fas fa-clock"></i> Pending
                            </span>
                            <span th:if="${vehicle.overallStatus == 'complete'}" class="status-badge status-complete">
                                <i class="fas fa-check-circle"></i> Complete
                            </span>
                            <span th:if="${vehicle.overallStatus == 'in_progress'}" class="status-badge status-in-progress">
                                <i class="fas fa-spinner"></i> In Progress
                            </span>
                        </td>
                        <td th:text="${vehicle.formattedRequestDate}">22/10/2024 10:30:00</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn-edit btn-view-detail" 
                                        title="Xem chi ti·∫øt"
                                        th:attr="data-vehicle-id=${vehicle.vehicleId}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Display total count -->
            <div class="pagination" style="justify-content: center; padding: 20px;">
                <span th:text="'T·ªïng s·ªë: ' + ${totalVehicles} + ' xe'">
                    T·ªïng s·ªë: 0 xe
                </span>
            </div>
        </div>

        <!-- L·ªãch S·ª≠ D·ªãch V·ª• Section -->
        <div class="table-section" style="margin-top: 32px;">
            <div class="table-header">
                <h3><i class="fas fa-history" style="color: #8B5CF6; margin-right: 8px;"></i> L·ªãch S·ª≠ D·ªãch V·ª•</h3>
            </div>

            <div class="table-container">
                <table class="vehicle-table">
                    <thead>
                    <tr>
                        <th>T√äN XE</th>
                        <th>BI·ªÇN S·ªê</th>
                        <th>LO·∫†I XE</th>
                        <th>T√äN D·ªäCH V·ª§</th>
                        <th>LO·∫†I D·ªäCH V·ª§</th>
                        <th>NG√ÄY Y√äU C·∫¶U</th>
                        <th>NG√ÄY HO√ÄN TH√ÄNH</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:if="${completedServices == null or completedServices.isEmpty()}">
                        <td colspan="7" style="text-align: center; padding: 40px; color: #9CA3AF;">
                            <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; display: block; opacity: 0.3;"></i>
                            Ch∆∞a c√≥ l·ªãch s·ª≠ d·ªãch v·ª•
                        </td>
                    </tr>
                    <tr th:each="service : ${completedServices}">
                        <td>
                            <div class="vehicle-info">
                                <div class="vehicle-icon" style="background: #E9D5FF; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-car" style="color: #7C3AED; font-size: 16px;"></i>
                                </div>
                                <div>
                                    <div class="vehicle-name" th:text="${service.vehicleName}">-</div>
                                </div>
                            </div>
                        </td>
                        <td th:text="${service.vehicleNumber}">-</td>
                        <td th:text="${service.vehicleType}">-</td>
                        <td th:text="${service.serviceName}">-</td>
                        <td>
                            <span class="status-badge status-complete" th:text="${service.serviceType}">-</span>
                        </td>
                        <td th:text="${service.formattedRequestDate}">-</td>
                        <td th:text="${service.formattedCompletionDate}">-</td>
                    </tr>
                    </tbody>
                </table>
            </div>

            <!-- Display total count -->
            <div class="pagination" style="justify-content: center; padding: 20px;">
                <span th:text="'T·ªïng s·ªë: ' + ${completedServices != null ? completedServices.size() : 0} + ' d·ªãch v·ª• ƒë√£ ho√†n th√†nh'">
                    T·ªïng s·ªë: 0 d·ªãch v·ª• ƒë√£ ho√†n th√†nh
                </span>
            </div>
        </div>
    </main>
</div>

<!-- Modal Chi Ti·∫øt Xe -->
<div id="vehicleDetailModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h2>Chi Ti·∫øt Xe</h2>
            <span class="modal-close" onclick="closeVehicleDetailModal()">&times;</span>
        </div>
        <div class="modal-body">
            <!-- Th√¥ng tin xe -->
            <div class="detail-section">
                <h3><i class="fas fa-car"></i> Th√¥ng Tin Xe</h3>
                <div class="detail-grid">
                    <div class="detail-item">
                        <label>M√£ Xe:</label>
                        <span id="modalVehicleId">-</span>
                    </div>
                    <div class="detail-item">
                        <label>T√™n Xe:</label>
                        <span id="modalVehicleName">-</span>
                    </div>
                    <div class="detail-item">
                        <label>Bi·ªÉn S·ªë:</label>
                        <span id="modalPlateNumber">-</span>
                    </div>
                    <div class="detail-item">
                        <label>Lo·∫°i Xe:</label>
                        <span id="modalVehicleType">-</span>
                    </div>
                </div>
            </div>

            <!-- Danh s√°ch d·ªãch v·ª• ƒëang ch·ªù -->
            <div class="detail-section">
                <h3 style="color: #4F46E5; border-bottom: 2px solid #E5E7EB; padding-bottom: 12px;">
                    <i class="fas fa-tools" style="color: #4F46E5;"></i> D·ªãch V·ª• ƒêang Ch·ªù
                    <small style="font-size: 12px; font-weight: normal; color: #6B7280; margin-left: 8px;">
                        (Pending / In Progress)
                    </small>
                </h3>
                <div id="modalServicesList" class="services-list">
                    <div class="loading-message">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>

            <!-- L·ªãch s·ª≠ d·ªãch v·ª• -->
            <div class="detail-section" style="margin-top: 32px;">
                <h3 style="color: #8B5CF6; border-bottom: 2px solid #E5E7EB; padding-bottom: 12px;">
                    <i class="fas fa-history" style="color: #8B5CF6;"></i> L·ªãch S·ª≠ D·ªãch V·ª•
                    <small style="font-size: 12px; font-weight: normal; color: #6B7280; margin-left: 8px;">
                        (C√°c d·ªãch v·ª• ƒë√£ ho√†n th√†nh - status = completed)
                    </small>
                </h3>
                <div id="modalServicesHistory" class="services-list services-history">
                    <div class="loading-message">ƒêang t·∫£i d·ªØ li·ªáu...</div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-save" onclick="saveChangesAndClose()">L∆∞u v√† ƒê√≥ng</button>
            <button type="button" class="btn-cancel" onclick="closeVehicleDetailModal()">H·ªßy</button>
        </div>
    </div>
</div>

<!-- Modal Th√™m D·ªãch V·ª• M·ªõi V√†o H·ªá Th·ªëng -->
<div id="addNewServiceModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Th√™m D·ªãch V·ª• M·ªõi V√†o H·ªá Th·ªëng</h2>
            <span class="modal-close" onclick="closeAddNewServiceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="addNewServiceForm">
                <div class="form-group">
                    <label for="newServiceId">M√£ d·ªãch v·ª• <span style="color: red;">*</span></label>
                    <input type="text" id="newServiceId" name="serviceId" required 
                           placeholder="VD: SRV001, MAINT001" 
                           pattern="[A-Za-z0-9]+" 
                           maxlength="20">
                    <small style="color: #6B7280; font-size: 12px; display: block; margin-top: 5px;">
                        M√£ d·ªãch v·ª• duy nh·∫•t (ch·ªØ v√† s·ªë, t·ªëi ƒëa 20 k√Ω t·ª±)
                    </small>
                </div>
                <div class="form-group">
                    <label for="newServiceName">T√™n d·ªãch v·ª• <span style="color: red;">*</span></label>
                    <input type="text" id="newServiceName" name="serviceName" required 
                           placeholder="VD: B·∫£o d∆∞·ª°ng ƒë·ªãnh k·ª≥, Ki·ªÉm tra t·ªïng th·ªÉ" 
                           maxlength="255">
                    <small style="color: #6B7280; font-size: 12px; display: block; margin-top: 5px;">
                        T√™n d·ªãch v·ª• (t·ªëi ƒëa 255 k√Ω t·ª±)
                    </small>
                </div>
                <div class="form-group">
                    <label for="newServiceType">Lo·∫°i d·ªãch v·ª• <span style="color: red;">*</span></label>
                    <select id="newServiceType" name="serviceType" required>
                        <option value="">-- Ch·ªçn lo·∫°i d·ªãch v·ª• --</option>
                        <option value="B·∫£o d∆∞·ª°ng">B·∫£o d∆∞·ª°ng</option>
                        <option value="Ki·ªÉm tra">Ki·ªÉm tra</option>
                        <option value="S·ª≠a ch·ªØa">S·ª≠a ch·ªØa</option>
                    </select>
                    <small style="color: #6B7280; font-size: 12px; display: block; margin-top: 5px;">
                        Ch·ªçn lo·∫°i d·ªãch v·ª• (B·∫£o d∆∞·ª°ng, Ki·ªÉm tra, S·ª≠a ch·ªØa)
                    </small>
                </div>
                <div id="addNewServiceMessage" style="display: none; margin-top: 15px;"></div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeAddNewServiceModal()">H·ªßy</button>
            <button type="button" class="btn-save" onclick="submitAddNewService()">Th√™m D·ªãch V·ª•</button>
        </div>
    </div>
</div>

<script>
    function applyFilter(event) {
        // NgƒÉn ch·∫∑n event bubbling v√† default behavior
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const searchQuery = document.querySelector('.filter-group input[type="text"]').value;
        const serviceFilter = document.getElementById('serviceFilter').value;
        const url = new URL(window.location.href);
        url.searchParams.set('searchQuery', searchQuery);
        url.searchParams.set('serviceFilter', serviceFilter);
        // B·ªè ph√¢n trang - kh√¥ng c·∫ßn page parameter
        url.searchParams.delete('page');
        window.location.href = url.toString();
    }
    
    // Auto-submit khi nh·∫•n Enter trong √¥ t√¨m ki·∫øm
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.querySelector('.filter-group input[type="text"]');
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    applyFilter(e);
                }
            });
        }
        
        // ƒê·∫£m b·∫£o n√∫t l·ªçc kh√¥ng b·ªã conflict v·ªõi script kh√°c
        const filterBtn = document.getElementById('btnFilter');
        if (filterBtn) {
            filterBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                applyFilter(e);
            });
        }
        
        // Event listener cho n√∫t xem chi ti·∫øt
        document.querySelectorAll('.btn-view-detail').forEach(btn => {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const vehicleId = this.getAttribute('data-vehicle-id');
                if (vehicleId) {
                    openVehicleDetailModal(vehicleId);
                }
            });
        });
    });

    // Bi·∫øn l∆∞u tr·ªØ thay ƒë·ªïi tr·∫°ng th√°i
    let statusChanges = {};
    let currentVehicleId = null;

    // Modal functions
    function openVehicleDetailModal(vehicleId) {
        console.log('M·ªü modal chi ti·∫øt cho xe: ' + vehicleId);
        const modal = document.getElementById('vehicleDetailModal');
        modal.style.display = 'block';
        currentVehicleId = vehicleId;
        statusChanges = {}; // Reset changes
        loadVehicleDetail(vehicleId);
    }

    function closeVehicleDetailModal(skipCheck = false) {
        // Ki·ªÉm tra n·∫øu c√≥ thay ƒë·ªïi ch∆∞a l∆∞u (tr·ª´ khi skipCheck = true)
        if (!skipCheck && Object.keys(statusChanges).length > 0) {
            if (confirm('B·∫°n c√≥ thay ƒë·ªïi ch∆∞a l∆∞u. B·∫°n c√≥ mu·ªën l∆∞u tr∆∞·ªõc khi ƒë√≥ng kh√¥ng?')) {
                saveChangesAndClose();
                return;
            }
        }
        const modal = document.getElementById('vehicleDetailModal');
        if (modal) {
            modal.style.display = 'none';
        }
        statusChanges = {}; // Reset changes
        currentVehicleId = null;
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i (s·∫Ω ƒë∆∞·ª£c override ·ªü cu·ªëi file)

    async function loadVehicleDetail(vehicleId) {
        try {
            const row = document.querySelector(`tr[data-vehicle-id="${vehicleId}"]`);
            if (row) {
                const vehicleName = row.querySelector('.vehicle-name')?.textContent || '-';
                const plateNumber = row.cells[1]?.textContent || '-';
                const vehicleType = row.cells[2]?.textContent || '-';
                document.getElementById('modalVehicleId').textContent = vehicleId;
                document.getElementById('modalVehicleName').textContent = vehicleName;
                document.getElementById('modalPlateNumber').textContent = plateNumber;
                document.getElementById('modalVehicleType').textContent = vehicleType;
            }
            const response = await fetch(`/admin/vehicle-manager/api/vehicle/${vehicleId}/services`);
            const data = await response.json();
            if (data.success && data.services) {
                displayServices(data.services);
                updateSaveButtonState(); // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t L∆∞u
            } else {
                document.getElementById('modalServicesList').innerHTML = '<div class="error-message">Kh√¥ng th·ªÉ t·∫£i danh s√°ch d·ªãch v·ª•</div>';
                document.getElementById('modalServicesHistory').innerHTML = '<div class="no-data">Kh√¥ng c√≥ l·ªãch s·ª≠ d·ªãch v·ª•</div>';
            }
        } catch (error) {
            console.error('L·ªói khi load chi ti·∫øt xe:', error);
            document.getElementById('modalServicesList').innerHTML = '<div class="error-message">ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu</div>';
            document.getElementById('modalServicesHistory').innerHTML = '<div class="error-message">ƒê√£ x·∫£y ra l·ªói khi t·∫£i l·ªãch s·ª≠</div>';
        }
    }

    function displayServices(services) {
        const servicesList = document.getElementById('modalServicesList');
        const servicesHistory = document.getElementById('modalServicesHistory');
        
        if (!services || services.length === 0) {
            servicesList.innerHTML = '<div class="no-data">Kh√¥ng c√≥ d·ªãch v·ª• ƒëang ch·ªù</div>';
            servicesHistory.innerHTML = '<div class="no-data">Kh√¥ng c√≥ l·ªãch s·ª≠ d·ªãch v·ª•</div>';
            return;
        }
        
        // Ph√¢n t√°ch d·ªãch v·ª• t·ª´ b·∫£ng vehicleservice:
        // - D·ªãch v·ª• ƒëang ch·ªù: pending, in_progress (t·ª´ b·∫£ng vehicleservice v·ªõi status != 'completed')
        // - L·ªãch s·ª≠ d·ªãch v·ª•: completed (l·ªçc t·ª´ b·∫£ng vehicleservice v·ªõi status = 'completed')
        const pendingServices = [];
        const completedServices = [];
        
        services.forEach(service => {
            const status = (service.status || 'pending').toLowerCase().trim();
            // L·ªçc d·ªãch v·ª• completed t·ª´ b·∫£ng vehicleservice ƒë·ªÉ hi·ªÉn th·ªã trong l·ªãch s·ª≠
            if (status === 'completed' || status === 'complete') {
                completedServices.push(service);
            } else {
                // D·ªãch v·ª• ƒëang ch·ªù: pending ho·∫∑c in_progress
                pendingServices.push(service);
            }
        });
        
        console.log('üìä Ph√¢n t√°ch d·ªãch v·ª• t·ª´ b·∫£ng vehicleservice:');
        console.log('   - D·ªãch v·ª• ƒëang ch·ªù (pending/in_progress):', pendingServices.length);
        console.log('   - L·ªãch s·ª≠ d·ªãch v·ª• (completed):', completedServices.length);
        
        // Hi·ªÉn th·ªã d·ªãch v·ª• ƒëang ch·ªù
        if (pendingServices.length === 0) {
            servicesList.innerHTML = '<div class="no-data">Kh√¥ng c√≥ d·ªãch v·ª• ƒëang ch·ªù</div>';
        } else {
            let html = '<div class="service-items">';
            pendingServices.forEach(service => {
                html += buildServiceItem(service, false);
            });
            html += '</div>';
            servicesList.innerHTML = html;
        }
        
        // Hi·ªÉn th·ªã l·ªãch s·ª≠ d·ªãch v·ª• (completed)
        if (completedServices.length === 0) {
            servicesHistory.innerHTML = '<div class="no-data">Kh√¥ng c√≥ l·ªãch s·ª≠ d·ªãch v·ª•</div>';
        } else {
            let html = '<div class="service-items">';
            completedServices.forEach(service => {
                html += buildServiceItem(service, true);
            });
            html += '</div>';
            servicesHistory.innerHTML = html;
        }
    }
    
    function buildServiceItem(service, isHistory) {
        // L·∫•y id t·ª´ service (id gi·ªù l√† Integer, primary key)
        // N·∫øu id l√† object (composite key c≈©), l·∫•y serviceId v√† vehicleId t·ª´ ƒë√≥
        let id = '';
        let serviceId = '';
        let vehicleId = '';
        
        if (service.id !== undefined && service.id !== null) {
            if (typeof service.id === 'object') {
                // T∆∞∆°ng th√≠ch ng∆∞·ª£c: id l√† object (composite key c≈©)
                id = '';
                serviceId = service.id.serviceId || '';
                vehicleId = service.id.vehicleId || '';
            } else {
                // id l√† Integer (primary key m·ªõi)
                id = service.id;
                serviceId = service.serviceId || '';
                vehicleId = service.vehicleId || '';
            }
        } else {
            // Fallback: l·∫•y t·ª´ root
            serviceId = service.serviceId || '';
            vehicleId = service.vehicleId || '';
        }
        
        const serviceName = service.serviceName || 'D·ªãch v·ª• kh√¥ng t√™n';
        const serviceType = service.serviceType || 'Kh√¥ng x√°c ƒë·ªãnh';
        const serviceDescription = service.serviceDescription || '';
        const status = (service.status || 'pending').toLowerCase().trim();
        const requestDate = service.requestDate ? formatDate(service.requestDate) : '-';
        const completionDate = service.completionDate ? formatDate(service.completionDate) : null;
        const isCompleted = status === 'completed' || status === 'Completed' || isHistory;
        const disabledAttr = isCompleted ? 'disabled' : '';
        const readonlyClass = isCompleted ? 'status-readonly' : '';
        const historyClass = isHistory ? 'service-history-item' : '';
        
        return `<div class="service-item ${historyClass}" data-id="${id}" data-service-id="${serviceId}" data-vehicle-id="${vehicleId}">
            <div class="service-header">
                <h4>${serviceName}</h4>
                <select class="status-select ${readonlyClass}" 
                        data-id="${id}"
                        data-service-id="${serviceId}" 
                        data-vehicle-id="${vehicleId}" 
                        data-original-status="${status}"
                        ${disabledAttr}
                        onchange="trackStatusChange(this)">
                    <option value="pending" ${status === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="in_progress" ${status === 'in_progress' || status === 'in progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
                ${isCompleted ? '<span class="readonly-badge">Ch·ªâ xem</span>' : ''}
            </div>
            <div class="service-details">
                <div class="detail-row"><label>Lo·∫°i d·ªãch v·ª•:</label><span>${serviceType}</span></div>
                <div class="detail-row"><label>M√¥ t·∫£:</label><span>${serviceDescription}</span></div>
                <div class="detail-row"><label>Ng√†y y√™u c·∫ßu:</label><span>${requestDate}</span></div>
                ${completionDate ? `<div class="detail-row"><label>Ng√†y ho√†n th√†nh:</label><span>${completionDate}</span></div>` : ''}
            </div>
        </div>`;
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        try {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
        } catch (e) {
            return dateString;
        }
    }

    // Theo d√µi thay ƒë·ªïi tr·∫°ng th√°i (kh√¥ng l∆∞u ngay)
    function trackStatusChange(selectElement) {
        // ∆Øu ti√™n s·ª≠ d·ª•ng id (primary key m·ªõi)
        const id = selectElement.getAttribute('data-id');
        const serviceId = selectElement.getAttribute('data-service-id');
        const vehicleId = selectElement.getAttribute('data-vehicle-id');
        const originalStatus = selectElement.getAttribute('data-original-status');
        const newStatus = selectElement.value;
        
        // S·ª≠ d·ª•ng id l√†m key n·∫øu c√≥, n·∫øu kh√¥ng th√¨ d√πng serviceId_vehicleId (t∆∞∆°ng th√≠ch ng∆∞·ª£c)
        const changeKey = id ? id : `${serviceId}_${vehicleId}`;
        
        if (!id && (!serviceId || !vehicleId)) {
            console.error('Kh√¥ng t√¨m th·∫•y id ho·∫∑c serviceId/vehicleId');
            return;
        }
        
        // N·∫øu tr·∫°ng th√°i tr·ªü v·ªÅ gi√° tr·ªã ban ƒë·∫ßu, x√≥a kh·ªèi danh s√°ch thay ƒë·ªïi
        if (newStatus === originalStatus) {
            delete statusChanges[changeKey];
        } else {
            // L∆∞u thay ƒë·ªïi v√†o object
            statusChanges[changeKey] = {
                id: id,
                serviceId: serviceId,
                vehicleId: vehicleId,
                newStatus: newStatus,
                originalStatus: originalStatus
            };
        }
        
        // C·∫≠p nh·∫≠t UI ƒë·ªÉ hi·ªÉn th·ªã c√≥ thay ƒë·ªïi
        updateSaveButtonState();
    }
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t L∆∞u
    function updateSaveButtonState() {
        const saveBtn = document.querySelector('.btn-save');
        if (saveBtn) {
            const hasChanges = Object.keys(statusChanges).length > 0;
            if (hasChanges) {
                saveBtn.style.opacity = '1';
                saveBtn.style.cursor = 'pointer';
                saveBtn.disabled = false;
                saveBtn.textContent = `L∆∞u v√† ƒê√≥ng (${Object.keys(statusChanges).length} thay ƒë·ªïi)`;
            } else {
                saveBtn.style.opacity = '0.6';
                saveBtn.style.cursor = 'not-allowed';
                saveBtn.disabled = true;
                saveBtn.textContent = 'L∆∞u v√† ƒê√≥ng';
            }
        }
    }
    
    // L∆∞u t·∫•t c·∫£ thay ƒë·ªïi v√† ƒë√≥ng modal
    async function saveChangesAndClose() {
        const changes = Object.values(statusChanges);
        
        // N·∫øu kh√¥ng c√≥ thay ƒë·ªïi, ch·ªâ c·∫ßn ƒë√≥ng modal v√† reload
        if (changes.length === 0) {
            closeVehicleDetailModal(true);
            // Reload ƒë·ªÉ ƒë·∫£m b·∫£o d·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t
            setTimeout(() => {
                window.location.reload();
            }, 100);
            return;
        }
        
        // Disable n√∫t l∆∞u ƒë·ªÉ tr√°nh double click
        const saveBtn = document.querySelector('.btn-save');
        if (saveBtn) {
            saveBtn.disabled = true;
            saveBtn.textContent = 'ƒêang l∆∞u...';
        }
        
        try {
            // L∆∞u t·ª´ng thay ƒë·ªïi
            // ∆Øu ti√™n s·ª≠ d·ª•ng endpoint m·ªõi v·ªõi id n·∫øu c√≥
            const updatePromises = changes.map(change => {
                if (change.id) {
                    // S·ª≠ d·ª•ng endpoint m·ªõi v·ªõi id
                    return fetch(`/admin/vehicle-manager/api/service/${change.id}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: change.newStatus })
                    });
                } else {
                    // Fallback: s·ª≠ d·ª•ng endpoint c≈© v·ªõi serviceId v√† vehicleId (t∆∞∆°ng th√≠ch ng∆∞·ª£c)
                    return fetch(`/admin/vehicle-manager/api/service/${change.serviceId}/vehicle/${change.vehicleId}/status`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ status: change.newStatus })
                    });
                }
            });
            
            const responses = await Promise.all(updatePromises);
            
            // Ki·ªÉm tra response status tr∆∞·ªõc khi parse JSON
            const errorResponses = responses.filter(r => !r.ok);
            if (errorResponses.length > 0) {
                const errorTexts = await Promise.all(errorResponses.map(r => r.text()));
                console.error('L·ªói khi l∆∞u:', errorTexts);
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u m·ªôt s·ªë thay ƒë·ªïi. Vui l√≤ng th·ª≠ l·∫°i.\n' + errorTexts.join('\n'));
                if (saveBtn) {
                    saveBtn.disabled = false;
                    updateSaveButtonState();
                }
                return;
            }
            
            // Parse JSON t·ª´ c√°c response th√†nh c√¥ng
            const results = await Promise.all(responses.map(r => r.json()));
            
            // Ki·ªÉm tra k·∫øt qu·∫£
            const failed = results.filter(r => !r.success);
            if (failed.length > 0) {
                const errorMessages = failed.map(r => r.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh').join('\n');
                alert('C√≥ l·ªói x·∫£y ra khi l∆∞u m·ªôt s·ªë thay ƒë·ªïi:\n' + errorMessages);
                if (saveBtn) {
                    saveBtn.disabled = false;
                    updateSaveButtonState();
                }
                return;
            }
            
            // L∆∞u th√†nh c√¥ng
            statusChanges = {};
            
            // ƒê·∫øm s·ªë d·ªãch v·ª• ƒë√£ c·∫≠p nh·∫≠t
            const completedCount = changes.filter(c => c.newStatus === 'completed' || c.newStatus === 'Completed').length;
            const updatedCount = changes.length;
            
            // C·∫≠p nh·∫≠t n√∫t l∆∞u ƒë·ªÉ hi·ªÉn th·ªã tr·∫°ng th√°i th√†nh c√¥ng
            if (saveBtn) {
                saveBtn.textContent = 'ƒê√£ l∆∞u th√†nh c√¥ng!';
                saveBtn.style.background = '#10B981';
                saveBtn.style.color = 'white';
            }
            
            // ƒê√≥ng modal tr∆∞·ªõc (b·ªè qua ki·ªÉm tra v√¨ ƒë√£ l∆∞u r·ªìi)
            closeVehicleDetailModal(true);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng trong console
            console.log(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng ${updatedCount} thay ƒë·ªïi.`);
            if (completedCount > 0) {
                console.log(`   - ${completedCount} d·ªãch v·ª• ƒë√£ ƒë∆∞·ª£c chuy·ªÉn sang completed.`);
            }
            
            // Reload trang ƒë·ªÉ c·∫≠p nh·∫≠t d·ªØ li·ªáu m·ªõi nh·∫•t
            // ƒê·ª£i m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o modal ƒë√£ ƒë√≥ng ho√†n to√†n
            setTimeout(() => {
                window.location.reload();
            }, 300);
            
        } catch (error) {
            console.error('L·ªói khi l∆∞u thay ƒë·ªïi:', error);
            alert('ƒê√£ x·∫£y ra l·ªói khi l∆∞u thay ƒë·ªïi: ' + error.message);
            if (saveBtn) {
                saveBtn.disabled = false;
                updateSaveButtonState();
            }
        }
    }

    // Modal Th√™m D·ªãch V·ª• M·ªõi V√†o H·ªá Th·ªëng
    function openAddNewServiceModal() {
        const modal = document.getElementById('addNewServiceModal');
        if (modal) {
            modal.style.display = 'block';
            
            // Reset form
            document.getElementById('addNewServiceForm').reset();
            
            // ·∫®n th√¥ng b√°o
            const messageDiv = document.getElementById('addNewServiceMessage');
            if (messageDiv) {
                messageDiv.style.display = 'none';
            }
        }
    }

    function closeAddNewServiceModal() {
        const modal = document.getElementById('addNewServiceModal');
        if (modal) {
            modal.style.display = 'none';
            // Reset form
            document.getElementById('addNewServiceForm').reset();
            // ·∫®n th√¥ng b√°o
            const messageDiv = document.getElementById('addNewServiceMessage');
            if (messageDiv) {
                messageDiv.style.display = 'none';
            }
        }
    }

    // Submit form th√™m d·ªãch v·ª• m·ªõi v√†o h·ªá th·ªëng
    async function submitAddNewService() {
        const serviceId = document.getElementById('newServiceId').value.trim();
        const serviceName = document.getElementById('newServiceName').value.trim();
        const serviceType = document.getElementById('newServiceType').value;
        
        // Validation
        if (!serviceId) {
            showAddNewServiceMessage('Vui l√≤ng nh·∫≠p m√£ d·ªãch v·ª•', 'error');
            return;
        }
        
        if (!serviceName) {
            showAddNewServiceMessage('Vui l√≤ng nh·∫≠p t√™n d·ªãch v·ª•', 'error');
            return;
        }
        
        if (!serviceType) {
            showAddNewServiceMessage('Vui l√≤ng ch·ªçn lo·∫°i d·ªãch v·ª•', 'error');
            return;
        }
        
        // Disable n√∫t submit
        const submitBtn = document.querySelector('#addNewServiceModal .btn-save');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.textContent = 'ƒêang th√™m...';
        }
        
        try {
            const requestData = {
                serviceId: serviceId,
                serviceName: serviceName,
                serviceType: serviceType
            };
            
            console.log('üì° [ADD NEW SERVICE] G·ª≠i request th√™m d·ªãch v·ª• m·ªõi:', requestData);
            
            const response = await fetch('/admin/vehicle-manager/api/services/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.success) {
                console.log('‚úÖ [ADD NEW SERVICE] ƒê√£ th√™m d·ªãch v·ª• m·ªõi th√†nh c√¥ng');
                showAddNewServiceMessage('ƒê√£ th√™m d·ªãch v·ª• m·ªõi v√†o h·ªá th·ªëng th√†nh c√¥ng!', 'success');
                
                // ƒê√≥ng modal sau 1.5 gi√¢y v√† reload trang
                setTimeout(() => {
                    closeAddNewServiceModal();
                    window.location.reload();
                }, 1500);
            } else {
                console.error('‚ùå [ADD NEW SERVICE] L·ªói khi th√™m d·ªãch v·ª•:', data.message);
                showAddNewServiceMessage(data.message || 'L·ªói khi th√™m d·ªãch v·ª•', 'error');
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Th√™m D·ªãch V·ª•';
                }
            }
        } catch (error) {
            console.error('‚ùå [ADD NEW SERVICE] L·ªói khi th√™m d·ªãch v·ª•:', error);
            showAddNewServiceMessage('L·ªói khi th√™m d·ªãch v·ª•: ' + error.message, 'error');
            if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Th√™m D·ªãch V·ª•';
            }
        }
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o trong modal th√™m d·ªãch v·ª• m·ªõi
    function showAddNewServiceMessage(message, type) {
        const messageDiv = document.getElementById('addNewServiceMessage');
        if (messageDiv) {
            messageDiv.textContent = message;
            messageDiv.className = type === 'success' ? 'alert alert-success' : 'alert alert-danger';
            messageDiv.style.display = 'block';
            
            if (type === 'success') {
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                }, 3000);
            }
        }
    }

    // ƒê√≥ng modal khi click b√™n ngo√†i
    window.addEventListener('click', function(event) {
        const vehicleDetailModal = document.getElementById('vehicleDetailModal');
        const addNewServiceModal = document.getElementById('addNewServiceModal');
        
        if (event.target == vehicleDetailModal) {
            closeVehicleDetailModal();
        }
        
        if (event.target == addNewServiceModal) {
            closeAddNewServiceModal();
        }
    });
</script>
<script th:src="@{/js/vehicle-manager.js}"></script>
</body>
</html>
