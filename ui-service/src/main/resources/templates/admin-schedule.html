<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Quản lý lịch xe - Admin</title>

    <!-- CDNs -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-bootstrap-4@5/bootstrap-4.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

    <style>
        :root {
            --primary: #4361ee;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --sidebar-w: 270px;
            --sidebar-c: 75px;
            --radius: 1rem;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
            font-family: 'Inter', 'Segoe UI', sans-serif;
            margin: 0; padding: 0; min-height: 100vh;
        }

        /* Sidebar (đồng bộ với trang đặt lịch) */
        .sidebar {
            position: fixed; top: 0; left: 0; height: 100vh;
            width: var(--sidebar-w); background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            color: #e2e8f0; z-index: 1000; box-shadow: var(--shadow);
            transition: var(--transition); overflow: hidden;
        }
        .sidebar.collapsed { width: var(--sidebar-c); }
        .sidebar-header {
            padding: 1.8rem 1.2rem; text-align: center; border-bottom: 1px solid #334155;
        }
        .logo {
            display: flex; align-items: center; justify-content: center; gap: 0.8rem;
            font-weight: 800; font-size: 1.5rem; color: #60a5fa;
        }
        .logo i {
            font-size: 2rem; background: linear-gradient(135deg, #60a5fa, #3b82f6);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }
        .nav-item {
            display: flex; align-items: center; padding: 1rem 1.5rem; color: #94a3b8;
            text-decoration: none; transition: var(--transition); position: relative;
            border-left: 4px solid transparent;
        }
        .nav-item i { width: 24px; font-size: 1.2rem; text-align: center; }
        .nav-item span { margin-left: 1rem; white-space: nowrap; font-weight: 500; }
        .sidebar.collapsed .nav-item span { opacity: 0; pointer-events: none; }
        .nav-item:hover { background: #1e293b; color: white; padding-left: 1.8rem; }
        .nav-item.active {
            background: linear-gradient(90deg, #3b82f6, transparent); color: white;
            border-left-color: #60a5fa; font-weight: 600;
        }
        .sidebar-toggle {
            position: fixed; top: 1.5rem; left: calc(var(--sidebar-w) + 1rem);
            background: white; border: none; width: 44px; height: 44px; border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); cursor: pointer; z-index: 999;
            transition: var(--transition);
        }
        .sidebar.collapsed + .sidebar-toggle { left: calc(var(--sidebar-c) + 1rem); }
        .sidebar-toggle i { font-size: 1.3rem; color: var(--primary); transition: transform 0.4s ease; }
        .sidebar.collapsed + .sidebar-toggle i { transform: rotate(180deg); }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-w); transition: var(--transition); padding: 2rem;
            min-height: 100vh;
        }
        .sidebar.collapsed ~ .main-content { margin-left: var(--sidebar-c); }

        /* Glass Card */
        .glass-card {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3); border-radius: var(--radius);
            box-shadow: var(--shadow); transition: var(--transition);
        }
        .glass-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }

        /* Table */
        .table {
            border-radius: var(--radius); overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        .table thead { background: linear-gradient(135deg, #f8fafc, #e2e8f0); color: #1e293b; font-weight: 600; }
        .table tbody tr { transition: var(--transition); }
        .table tbody tr:hover { background: #f1f5f9; transform: scale(1.01); }
        .badge { font-size: 0.8rem; padding: 0.4em 0.8em; border-radius: 0.5rem; }
        .action-btns .btn { padding: 0.4rem 0.8rem; font-size: 0.85rem; border-radius: 0.5rem; }

        /* Filters & Search */
        .filter-group { background: white; border-radius: var(--radius); padding: 1rem; box-shadow: var(--shadow); }
        .form-control, .form-select { border-radius: 0.6rem; border: 2px solid #e2e8f0; }
        .form-control:focus, .form-select:focus { border-color: var(--primary); box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.2); }

        /* Loading Spinner */
        .spinner { display: none; text-align: center; padding: 2rem; }
        .spinner i { font-size: 1.5rem; color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 992px) {
            .sidebar, .sidebar.collapsed { width: var(--sidebar-c); }
            .main-content { margin-left: var(--sidebar-c); }
            .sidebar-toggle { left: calc(var(--sidebar-c) + 1rem); }
            .nav-item span { opacity: 0; }
        }
        @media (max-width: 576px) {
            .main-content { padding: 1rem; }
            .filter-group { flex-direction: column; gap: 0.5rem; }
        }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <a href="#" class="logo">
            <i class="fas fa-car"></i>
            <span>CarShare Pro</span>
        </a>
    </div>
    <nav class="sidebar-nav">
        <a href="#" class="nav-item"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a>
        <a href="#" class="nav-item"><i class="fas fa-car"></i><span>Xe</span></a>
        <a href="#" class="nav-item active"><i class="fas fa-clipboard-check"></i><span>Đặt lịch</span></a>
        <a href="#" class="nav-item"><i class="fas fa-users"></i><span>Thành viên</span></a>
        <a href="#" class="nav-item"><i class="fas fa-chart-line"></i><span>Báo cáo</span></a>
        <a href="#" class="nav-item"><i class="fas fa-cog"></i><span>Cài đặt</span></a>
    </nav>
</aside>

<button class="sidebar-toggle" id="sidebarToggle">
    <i class="fas fa-chevron-left"></i>
</button>

<!-- MAIN CONTENT -->
<main class="main-content">
    <div class="container-fluid">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-primary mb-1">
                    <i class="bi bi-calendar-week"></i> Quản lý lịch xe
                </h2>
                <p class="text-muted">Theo dõi và quản lý lịch sử dụng xe đồng sở hữu</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary" onclick="toggleDarkMode()">
                    <i class="bi bi-moon-stars-fill"></i>
                </button>
                <button class="btn btn-outline-danger" id="logoutBtn">
                    <i class="bi bi-box-arrow-right"></i> Đăng xuất
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-group d-flex gap-3 mb-4">
            <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm xe, người đặt...">
            <select id="statusFilter" class="form-select">
                <option value="">Tất cả trạng thái</option>
                <option value="CONFIRMED">Đã xác nhận</option>
                <option value="CANCELLED">Đã hủy</option>
                <option value="PENDING">Đang chờ</option>
            </select>
            <button class="btn btn-primary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise"></i> Tải lại
            </button>
            <button class="btn btn-success" onclick="exportToCSV()">
                <i class="bi bi-file-earmark-arrow-down"></i> Xuất CSV
            </button>
        </div>

        <!-- Table -->
        <div class="glass-card">
            <div class="card-body p-4">
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                        <tr>
                            <th>ID</th>
                            <th>Xe</th>
                            <th>Người đặt</th>
                            <th>Ngày bắt đầu</th>
                            <th>Ngày kết thúc</th>
                            <th>Trạng thái</th>
                            <th>Ghi chú</th>
                            <th>Thao tác</th>
                        </tr>
                        </thead>
                        <tbody id="scheduleTableBody">
                        <tr><td colspan="8" class="spinner"><i class="bi bi-arrow-repeat"></i></td></tr>
                        </tbody>
                    </table>
                </div>
                <!-- Pagination -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">Hiển thị <span id="paginationInfo"></span> lịch</div>
                    <nav>
                        <ul class="pagination mb-0">
                            <li class="page-item"><a class="page-link" href="#" onclick="changePage(-1)">«</a></li>
                            <li class="page-item"><a class="page-link" href="#" id="currentPage">1</a></li>
                            <li class="page-item"><a class="page-link" href="#" onclick="changePage(1)">»</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    const token = localStorage.getItem("token");
    const API_URL = "http://localhost:8082/api/admin/reservations";
    const tableBody = document.getElementById("scheduleTableBody");
    let schedules = [];
    let currentPage = 1;
    const pageSize = 10;

    // Kiểm tra đăng nhập
    if (!token) {
        window.location.href = "/admin-login";
    }

    // Sidebar toggle
    document.getElementById('sidebarToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.toggle('collapsed');
    });

    // Dark mode
    function toggleDarkMode() {
        document.body.classList.toggle('bg-dark');
        document.body.style.background = document.body.classList.contains('bg-dark')
            ? 'linear-gradient(135deg, #1a1a2e, #16213e)' : 'linear-gradient(135deg, #f0f4f8, #d9e2ec)';
    }

    // Tải danh sách lịch
    async function loadSchedules() {
        tableBody.innerHTML = '<tr><td colspan="8" class="spinner"><i class="bi bi-arrow-repeat"></i></td></tr>';
        try {
            const res = await fetch(API_URL, {
                headers: { "Authorization": "Bearer " + token }
            });
            if (!res.ok) {
                tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Không thể tải dữ liệu</td></tr>';
                return;
            }
            schedules = await res.json();
            filterAndRender();
        } catch {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Lỗi kết nối máy chủ</td></tr>';
        }
    }

    // Lọc và hiển thị bảng
    function filterAndRender() {
        const search = document.getElementById('searchInput').value.toLowerCase();
        const status = document.getElementById('statusFilter').value;
        let filtered = schedules.filter(s =>
            (s.vehicleId?.toString().includes(search) ||
                s.userId?.toString().includes(search) ||
                s.purpose?.toLowerCase().includes(search)) &&
            (!status || s.status === status)
        );

        const total = filtered.length;
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        filtered = filtered.slice(start, end);

        renderTable(filtered);
        document.getElementById('paginationInfo').textContent = `${start + 1}-${Math.min(end, total)} / ${total}`;
        document.getElementById('currentPage').textContent = currentPage;
    }

    // Hiển thị bảng
    function renderTable(data) {
        if (!data.length) {
            tableBody.innerHTML = '<tr><td colspan="8" class="text-center py-5"><i class="bi bi-inbox display-1 opacity-25"></i><br>Không có lịch nào</td></tr>';
            return;
        }
        tableBody.innerHTML = '';
        data.forEach(s => {
            const row = `
                    <tr>
                        <td>${s.reservationId}</td>
                        <td>${s.vehicleId || '-'}</td>
                        <td>${s.userId || '-'}</td>
                        <td>${new Date(s.startDatetime).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                        <td>${new Date(s.endDatetime).toLocaleString('vi-VN', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</td>
                        <td><span class="badge ${s.status === 'CONFIRMED' ? 'bg-success' : s.status === 'CANCELLED' ? 'bg-danger' : 'bg-warning'}">${s.status}</span></td>
                        <td>${s.purpose || '-'}</td>
                        <td class="action-btns">
                            <button class="btn btn-danger btn-sm" onclick="deleteSchedule(${s.reservationId})"><i class="bi bi-trash"></i> Xóa</button>
                        </td>
                    </tr>`;
            tableBody.innerHTML += row;
        });
    }

    // Xóa lịch
    async function deleteSchedule(id) {
        const result = await Swal.fire({
            title: 'Xác nhận xóa',
            text: `Bạn có chắc muốn xóa lịch #${id}?`,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Xóa',
            cancelButtonText: 'Hủy'
        });

        if (!result.isConfirmed) return;

        try {
            const res = await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            if (res.ok) {
                Swal.fire('Thành công!', 'Đã xóa lịch.', 'success');
                loadSchedules();
            } else {
                Swal.fire('Lỗi!', `Không thể xóa (mã lỗi ${res.status})`, 'error');
            }
        } catch {
            Swal.fire('Lỗi!', 'Không kết nối được máy chủ.', 'error');
        }
    }

    // Phân trang
    function changePage(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        filterAndRender();
    }

    // Xuất CSV
    function exportToCSV() {
        const headers = ['ID,Lịch,Tên xe,Người đặt,Ngày bắt đầu,Ngày kết thúc,Trạng thái,Ghi chú'];
        const rows = schedules.map(s => [
            s.reservationId,
            s.vehicleId || '-',
            s.userId || '-',
            `"${new Date(s.startDatetime).toLocaleString('vi-VN')}"`,
            `"${new Date(s.endDatetime).toLocaleString('vi-VN')}"`,
            s.status,
            `"${s.purpose || '-'}"`
        ].join(','));
        const csv = [headers, ...rows].join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'lich_xe.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    // Sự kiện
    document.getElementById('logoutBtn').addEventListener('click', () => {
        Swal.fire({
            title: 'Đăng xuất',
            text: 'Bạn có muốn đăng xuất?',
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Đăng xuất',
            cancelButtonText: 'Hủy'
        }).then(result => {
            if (result.isConfirmed) {
                localStorage.removeItem('token');
                localStorage.removeItem('username');
                window.location.href = '/admin-login';
            }
        });
    });

    document.getElementById('refreshBtn').addEventListener('click', loadSchedules);
    document.getElementById('searchInput').addEventListener('input', filterAndRender);
    document.getElementById('statusFilter').addEventListener('change', filterAndRender);

    // Tải lần đầu
    loadSchedules();
</script>
</body>
</html>